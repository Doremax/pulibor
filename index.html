<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Система Учета Расходов</title>
    <style>
        /* ============================================================================ */
        /* ОСНОВНЫЕ СТИЛИ МАКЕТА */
        /* ============================================================================ */
        :root {
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --header-height: 60px;
            --bottom-nav-height: 60px; /* Фиксированная высота контента панели */
            --sidebar-width: 280px; 
            --chart-bar-color: #667eea; 
            --chart-label-color: #555;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-overflow-scrolling: touch; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        
        /* ОБЕРТКА КОНТЕНТА: Управляем padding-bottom через JS */
        .content-wrapper { 
             padding-top: calc(var(--header-height) + var(--safe-area-top)); 
             /* ИЗМЕНЕНИЕ: Используем padding-bottom вместо margin-bottom */
             padding-bottom: 0; /* Управляется JS */
             margin-bottom: 0; /* Убран */
             transition: padding-bottom 0.3s ease; /* Плавный переход */
             min-height: calc(100vh - (var(--header-height) + var(--safe-area-top))); 
             display: flex; 
             flex-direction: column;
        }
        .container { max-width: 100%; margin: 0 auto; background: white; flex-grow: 1; }

        /* HEADER */
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0 15px; display: flex; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: calc(var(--header-height) + var(--safe-area-top)); padding-top: var(--safe-area-top); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header h1 { font-size: 20px; font-weight: 600; }
        
        /* SIDEBAR */
        .sidebar { position: fixed; top: 0; right: 0; left: auto; width: var(--sidebar-width); height: 100%; background: #f8f9fa; z-index: 1002; transform: translateX(100%); transition: transform 0.3s ease-out; box-shadow: -4px 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .sidebar.active { transform: translateX(0); }
        .sidebar-header { padding: 20px; padding-top: calc(var(--safe-area-top) + 20px); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .sidebar-header .user-info { margin-bottom: 15px; } .user-info span { font-size: 16px; font-weight: 500; opacity: 0.9; }
        .theme-toggle { background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background 0.3s; } .theme-toggle:hover { background: rgba(255, 255, 255, 0.3); }
        .sidebar-nav { display: flex; flex-direction: column; flex: 1; overflow-y: auto; }
        .nav-tab { width: 100%; padding: 16px 20px; cursor: pointer; background: #f8f9fa; border: none; font-size: 16px; font-weight: 500; color: #666; transition: all 0.3s; border-bottom: 1px solid #e9ecef; border-right: 4px solid transparent; border-left: none; display: flex; align-items: center; text-align: left; }
        .nav-tab .icon { font-size: 20px; margin-right: 15px; width: 24px; display: inline-block; text-align: center; color: #555; }
        .nav-tab:hover { background: #e9ecef; color: #333; } .nav-tab.active { background: white; color: #667eea; border-right-color: #667eea; } .nav-tab.active .icon { color: #667eea; }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; } .sidebar-overlay.active { opacity: 1; visibility: visible; }

        /* ============================================================================ */
        /* BOTTOM NAV (ИСПРАВЛЕНО - Новый подход) */
        /* ============================================================================ */
        .bottom-nav { 
            position: fixed; 
            /* ИЗМЕНЕНИЕ: Прижимаем к самому низу */
            bottom: 0; 
            left: 0; 
            right: 0; 
            z-index: 100; 
            background: #f8f9fa; 
            border-top: 1px solid #e9ecef; 
            box-shadow: 0 -4px 15px rgba(0,0,0,0.05); 
            display: none; /* JS управляет */
            /* ИЗМЕНЕНИЕ: Высота контентной части */
            height: var(--bottom-nav-height); 
            /* ИЗМЕНЕНИЕ: Отступ *внутри* панели для системных кнопок */
            padding-bottom: var(--safe-area-bottom); 
            /* ИЗМЕНЕНИЕ: Убедимся, что padding добавляется к высоте */
            box-sizing: content-box; 
        }
        .bottom-nav-item { background: none; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; 
            /* ИЗМЕНЕНИЕ: Высота кнопки = высоте контентной части панели */
            height: var(--bottom-nav-height); 
            font-size: 10px; color: #666; transition: background 0.3s; padding: 5px 0; }
        .bottom-nav-item:hover { background: #e9ecef; } .bottom-nav-item .icon { font-size: 24px; margin-bottom: 2px; }
        
        /* DARK THEME */
        body.dark-theme { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); } body.dark-theme .container { background: #0f3460; color: #e0e0e0; } body.dark-theme .sidebar { background: #1a1a2e; } body.dark-theme .sidebar-header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); } body.dark-theme .nav-tab { background: #1a1a2e; color: #999; border-bottom-color: #16213e; } body.dark-theme .nav-tab .icon { color: #888; } body.dark-theme .nav-tab:hover { background: #16213e; color: #ccc; } body.dark-theme .nav-tab.active { background: #0f3460; color: #667eea; } body.dark-theme .nav-tab.active .icon { color: #667eea; } body.dark-theme .bottom-nav { background: #1a1a2e; border-top-color: #16213e; } body.dark-theme .bottom-nav-item { color: #999; } body.dark-theme .bottom-nav-item:hover { background: #16213e; } body.dark-theme .form-container, body.dark-theme .filters { background: #1a1a2e; } body.dark-theme .form-group input, body.dark-theme .form-group select, body.dark-theme .form-group textarea, body.dark-theme .filter-group input, body.dark-theme .filter-group select { background: #16213e; border-color: #16213e; color: #e0e0e0; } body.dark-theme table { background: #1a1a2e; } body.dark-theme thead { background: #16213e; border-bottom-color: #16213e; } body.dark-theme th { color: #e0e0e0; } body.dark-theme td { color: #e0e0e0; border-bottom-color: #16213e; } body.dark-theme tbody tr:hover { background: #16213e; } body.dark-theme .chart-container { background: #1a1a2e; border-color: #16213e; color: #e0e0e0; } 
        body.dark-theme .chart { background: #16213e; color: #bbb; } body.dark-theme .chart .bar { background-color: #7f8dde; } body.dark-theme .chart .label { color: #aaa; } body.dark-theme .chart .value { color: #ddd; }
        body.dark-theme .balance-item { background: #1a1a2e; border-color: #16213e; } body.dark-theme .balance-item-info h4 { color: #e0e0e0; } body.dark-theme .btn-secondary { background: #16213e; color: #e0e0e0; } body.dark-theme .btn-secondary:hover { background: #0f3460; } body.dark-theme .modal-content { background: #0f3460; color: #e0e0e0; } body.dark-theme .modal-header { border-bottom-color: #16213e; } body.dark-theme .modal-header h2 { color: #e0e0e0; } body.dark-theme .form-group label { color: #e0e0e0; }

        /* CONTENT STYLES */
        .content { padding: 20px; display: none; } .content.active { display: block; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 25px; } 
        .card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); } 
        .card h3 { font-size: 12px; opacity: 0.9; margin-bottom: 5px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } 
        .card .value { font-size: 20px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } 
        .card.positive { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); } .card.negative { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); } .card.info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .form-container { background: #f8f9fa; padding: 30px; border-radius: 12px; margin-bottom: 20px; } .form-group { margin-bottom: 20px; } .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px; } .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit; transition: all 0.3s; } .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; display: inline-block; } .btn-primary { background: #667eea; color: white; } .btn-primary:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); } .btn-success { background: #11998e; color: white; } .btn-success:hover { background: #0d7a6a; } .btn-danger { background: #eb3349; color: white; } .btn-danger:hover { background: #d42a3d; } .btn-secondary { background: #e9ecef; color: #333; } .btn-secondary:hover { background: #dee2e6; } .btn-small { padding: 8px 16px; font-size: 12px; } .btn-block { width: 100%; display: block; }
        .filters { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; } .filter-group { display: flex; flex-direction: column; } .filter-group label { font-size: 12px; font-weight: 600; color: #666; margin-bottom: 5px; text-transform: uppercase; } .filter-group input, .filter-group select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit; } .filter-group input:focus, .filter-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); } .filter-buttons { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #e9ecef; } table { width: 100%; border-collapse: collapse; background: white; } thead { background: #f8f9fa; border-bottom: 2px solid #e9ecef; } th { padding: 15px; text-align: left; font-weight: 600; color: #333; font-size: 13px; text-transform: uppercase; } td { padding: 15px; border-bottom: 1px solid #e9ecef; font-size: 14px; } tbody tr:hover { background: #f8f9fa; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; } .status-approved { background: #d4edda; color: #155724; } .status-pending { background: #fff3cd; color: #856404; } .status-rejected { background: #f8d7da; color: #721c24; }
        .chart-container { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e9ecef; margin-bottom: 20px; } .chart-container h3 { margin-bottom: 20px; color: #333; font-size: 16px; }
        .chart { width: 100%; min-height: 250px; background: #f8f9fa; border-radius: 8px; display: flex; flex-direction: column; padding: 20px; color: #999; font-size: 14px; overflow-x: auto; } .chart-bars { display: flex; align-items: flex-end; height: 180px; border-bottom: 1px solid #ddd; margin-bottom: 10px; gap: 5px; } .chart-bar-item { flex: 1; display: flex; flex-direction: column; align-items: center; text-align: center; min-width: 40px; } .chart .bar { width: 80%; background-color: var(--chart-bar-color); border-radius: 4px 4px 0 0; transition: height 0.3s ease; } .chart .value { font-size: 10px; color: var(--chart-label-color); margin-top: 3px; font-weight: bold; white-space: nowrap; } .chart .label { font-size: 10px; color: var(--chart-label-color); margin-top: 5px; white-space: nowrap; transform: rotate(-45deg); transform-origin: top right; }
        .balance-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; } .balance-item { background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 20px; display: flex; justify-content: space-between; align-items: center; } .balance-item-info h4 { font-size: 16px; color: #333; margin-bottom: 5px; } .balance-item-info p { font-size: 12px; color: #999; } .balance-item-value { font-size: 24px; font-weight: 700; text-align: right; } .balance-item-value.positive { color: #11998e; } .balance-item-value.negative { color: #eb3349; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); animation: fadeIn 0.3s; } .modal.active { display: flex; align-items: center; justify-content: center; } .modal-content { background-color: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); animation: slideIn 0.3s; } .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e9ecef; } .modal-header h2 { font-size: 20px; color: #333; } .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; } .modal-close:hover { color: #333; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } } @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .alert { padding: 15px; margin-bottom: 20px; border-radius: 6px; display: none; animation: slideIn 0.3s; } .alert.active { display: block; } .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; } .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; } .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; } .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .loading { text-align: center; padding: 40px; color: #999; } .spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; } .empty-state-icon { font-size: 64px; margin-bottom: 20px; } .empty-state-text { font-size: 16px; margin-bottom: 10px; }
        @media (max-width: 768px) { .filters { grid-template-columns: 1fr; } .modal-content { width: 95%; } .balance-list { grid-template-columns: 1fr; } }
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; } .action-card { flex: 1; min-width: 150px; padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; } .action-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); } .action-card-icon { font-size: 32px; margin-bottom: 10px; } .action-card-title { font-weight: 600; font-size: 14px; } .action-card.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; } .action-card.success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; } .action-card.warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
    </style>
</head>
<body class=""> 
    <div class="header"> <h1 id="headerTitle">Загрузка...</h1> </div>
    <div class="sidebar" id="sidebar"> <div class="sidebar-header"> <div class="user-info"> <span id="userRole">Роль: Загрузка...</span> </div> <button class="theme-toggle" onclick="toggleTheme()">🌙 Темная</button> </div> <div class="sidebar-nav"> <button class="nav-tab active" id="nav-dashboard" onclick="switchTab('dashboard')"><span class="icon">🏠</span> <span>Главная</span></button> <button class="nav-tab" id="nav-operations" onclick="switchTab('operations')"><span class="icon">💳</span> <span>Операции</span></button> <button class="nav-tab" id="nav-received" onclick="switchTab('received')" style="display: none;"><span class="icon">💰</span> <span>Получено</span></button> <button class="nav-tab" id="nav-journal" onclick="switchTab('journal')"><span class="icon">📄</span> <span>Журнал</span></button> <button class="nav-tab" id="nav-transfers" onclick="switchTab('transfers')" style="display: none;"><span class="icon">➡️</span> <span>Входящие</span></button> <button class="nav-tab" id="nav-balances" onclick="switchTab('balances')"><span class="icon">🏦</span> <span>Балансы</span></button> <button class="nav-tab" id="nav-analytics" onclick="switchTab('analytics')"><span class="icon">📈</span> <span>Аналитика</span></button> <button class="nav-tab" id="nav-approvals" onclick="switchTab('approvals')"><span class="icon">✅</span> <span>Подтверждения</span></button> </div> </div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    <div class="content-wrapper" id="contentWrapper"> <div class="container"> <div id="alertContainer" style="padding: 20px 20px 0;"> <div id="successAlert" class="alert alert-success"></div> <div id="errorAlert" class="alert alert-error"></div> <div id="warningAlert" class="alert alert-warning"></div> <div id="infoAlert" class="alert alert-info"></div> </div> 
        <div id="dashboard" class="content active"> <div class="cards-grid"> <div class="card"> <h3>Мои расходы</h3> <div class="value" id="totalExpenses">0 ₽</div> </div> <div class="card"> <h3>Мне выдано</h3> <div class="value" id="totalIssued">0 ₽</div> </div> <div class="card"> <h3>Мои запросы</h3> <div class="value" id="pendingRequests">0</div> </div> <div class="card positive"> <h3>Мой баланс</h3> <div class="value" id="totalBalance">0 ₽</div> </div> <div class="card info" id="responsibleBalanceCard" style="display: none;"> <h3>Баланс Ответств.</h3> <div class="value" id="responsibleBalance">0 ₽</div> </div> </div> <div class="action-buttons"> <div class="action-card primary" onclick="openModal('requestFundsModal')"> <div class="action-card-icon">📥</div> <div class="action-card-title">Запросить средства</div> </div> <div class="action-card success" onclick="openModal('recordExpenseModal')"> <div class="action-card-icon">💸</div> <div class="action-card-title">Совершить расход</div> </div> <div class="action-card warning" onclick="openModal('transferFundsModal')"> <div class="action-card-icon">↔️</div> <div class="action-card-title">Передать средства</div> </div> </div> <div class="chart-container"> <h3>📊 Расходы по категориям (30 дней)</h3> <div class="chart" id="categoryChart"><div class="loading"><div class="spinner"></div></div></div> </div> <div class="chart-container"> <h3>📈 Тренд расходов (30 дней)</h3> <div class="chart" id="trendChart"><div class="loading"><div class="spinner"></div></div></div> </div> </div> 
        <div id="operations" class="content"> <h2 style="margin-bottom: 20px;">💼 Управление операциями</h2> <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;"> <div class="action-card primary" onclick="openModal('requestFundsModal')" style="cursor: pointer;"> <div class="action-card-icon">📥</div> <div class="action-card-title">Запросить средства</div> <p style="font-size: 12px; margin-top: 10px; opacity: 0.9;">Запросить денежные средства</p> </div> <div class="action-card success" onclick="openModal('recordExpenseModal')" style="cursor: pointer;"> <div class="action-card-icon">💸</div> <div class="action-card-title">Совершить расход</div> <p style="font-size: 12px; margin-top: 10px; opacity: 0.9;">Записать расход и категорию</p> </div> <div class="action-card warning" onclick="openModal('transferFundsModal')" style="cursor: pointer;"> <div class="action-card-icon">↔️</div> <div class="action-card-title">Передать средства</div> <p style="font-size: 12px; margin-top: 10px; opacity: 0.9;">Передать денежные средства сотруднику</p> </div> </div> </div> 
        <div id="received" class="content"> <h2 style="margin-bottom: 20px;">💰 Получено в этом месяце</h2> <div class="loading"><div class="spinner"></div><p>Загрузка...</p></div> </div> 
        <div id="journal" class="content"> <h2 style="margin-bottom: 20px;">📋 Журнал операций</h2> <div class="filters"> <div class="filter-group"> <label>Дата от</label> <input type="date" id="filterDateFrom" onchange="applyFilters()"> </div> <div class="filter-group"> <label>Дата до</label> <input type="date" id="filterDateTo" onchange="applyFilters()"> </div> <div class="filter-group"> <label>Тип</label> <select id="filterType" onchange="applyFilters()"> <option value="">Все</option> <option value="Запрос">Запрос</option> <option value="Выдача">Выдача</option> <option value="Расход">Расход</option> <option value="Возврат">Возврат</option> <option value="Передача">Передача</option> </select> </div> <div class="filter-group"> <label>Статус</label> <select id="filterStatus" onchange="applyFilters()"> <option value="">Все</option> <option value="Подтверждено">Подтверждено</option> <option value="Ожидает">Ожидает</option> <option value="Отклонено">Отклонено</option> </select> </div> <div class="filter-buttons"> <button class="btn btn-primary" onclick="applyFilters()">🔍</button> <button class="btn btn-secondary" onclick="resetFilters()">↺</button> <button class="btn btn-success" onclick="exportToCSV()">📥 CSV</button> </div> </div> <div class="table-container"> <table id="journalTable"> <thead> <tr> <th>Дата</th> <th>ID</th> <th>Тип</th> <th>Статус</th> <th>Сумма</th> <th>От кого</th> <th>Кому</th> <th>Категория</th> <th>Комментарий</th> </tr> </thead> <tbody id="journalBody"> <tr><td colspan="9" class="loading"><div class="spinner"></div></td></tr> </tbody> </table> </div> </div> 
        <div id="transfers" class="content"> <h2 style="margin-bottom: 20px;">➡️ Входящие переводы</h2> <div class="empty-state"> <div class="loading"><div class="spinner"></div></div> </div> </div> 
        <div id="balances" class="content"> <h2 style="margin-bottom: 20px;">💵 Балансы сотрудников</h2> <div class="balance-list" id="balancesList"> <div class="loading"><div class="spinner"></div></div> </div> </div> 
        <div id="analytics" class="content"> <h2 style="margin-bottom: 20px;">📈 Аналитика</h2> <div class="filters"> <div class="filter-group"> <label>Период</label> <select id="analyticsPeriod" onchange="loadAnalytics()"> <option value="daily">По дням</option> <option value="weekly">По неделям</option> <option value="monthly" selected>По месяцам</option> <option value="yearly">По годам</option> </select> </div> <div class="filter-group"> <label>Месяцы назад</label> <select id="analyticsMonths" onchange="loadAnalytics()"> <option value="1">1 мес.</option> <option value="3" selected>3 мес.</option> <option value="6">6 мес.</option> <option value="12">Год</option> </select> </div> <div class="filter-group"> <label>Сотрудник</label> <select id="analyticsEmployee" onchange="loadAnalytics()"> <option value="">Все</option> </select> </div> </div> <div class="chart-container"> <h3>📊 Расходы по категориям</h3> <div class="chart" id="analyticsCategoryChart"><div class="loading"><div class="spinner"></div></div></div> </div> <div class="chart-container"> <h3>👥 Расходы по сотрудникам</h3> <div class="chart" id="analyticsEmployeeChart"><div class="loading"><div class="spinner"></div></div></div> </div> <div class="chart-container"> <h3>📈 Тренд расходов</h3> <div class="chart" id="analyticsTrendChart"><div class="loading"><div class="spinner"></div></div></div> </div> </div> 
        <div id="approvals" class="content"> <h2 style="margin-bottom: 20px;">✅ Подтверждение запросов</h2> <div class="table-container"> <table id="approvalsTable"> <thead> <tr> <th>Дата</th> <th>ID</th> <th>От кого</th> <th>Сумма</th> <th>Статус</th> <th>Комментарий</th> <th>Действие</th> </tr> </thead> <tbody id="approvalsBody"> <tr><td colspan="7" class="loading"><div class="spinner"></div></td></tr> </tbody> </table> </div> </div> 
    </div> </div> 
    <div id="requestFundsModal" class="modal"> <div class="modal-content"> <div class="modal-header"> <h2>📥 Запросить</h2> <button class="modal-close" onclick="closeModal('requestFundsModal')">✕</button> </div> <form onsubmit="submitRequestFunds(event)"> <div class="form-group"> <label>Сумма (₽)</label> <input type="number" id="requestAmount" min="1" step="0.01" required> </div> <div class="form-group"> <label>Комментарий</label> <textarea id="requestComment" rows="3"></textarea> </div> <button type="submit" class="btn btn-primary btn-block">Отправить</button> </form> </div> </div>
    <div id="recordExpenseModal" class="modal"> <div class="modal-content"> <div class="modal-header"> <h2>💸 Расход</h2> <button class="modal-close" onclick="closeModal('recordExpenseModal')">✕</button> </div> <form onsubmit="submitRecordExpense(event)"> <div class="form-group"> <label>Сумма (₽)</label> <input type="number" id="expenseAmount" min="1" step="0.01" required> </div> <div class="form-group"> <label>Категория</label> <div style="display: flex; gap: 10px;"> <select id="expenseCategory" required onchange="updateSubcategories()"> <option value="">Выбрать...</option> </select> <button type="button" class="btn btn-secondary btn-small" id="addCategoryBtn" onclick="openModal('addCategoryModal')" style="display: none;">+</button> </div> </div> <div class="form-group"> <label>Подкатегория</label> <select id="expenseSubcategory" required> <option value="">Выбрать...</option> </select> </div> <div class="form-group"> <label>Комментарий</label> <textarea id="expenseComment" rows="3"></textarea> </div> <button type="submit" class="btn btn-primary btn-block">Записать</button> </form> </div> </div>
    <div id="transferFundsModal" class="modal"> <div class="modal-content"> <div class="modal-header"> <h2>↔️ Передать</h2> <button class="modal-close" onclick="closeModal('transferFundsModal')">✕</button> </div> <form onsubmit="submitTransferFunds(event)"> <div class="form-group"> <label>Кому</label> <select id="transferTo" required> <option value="">Выбрать...</option> </select> </div> <div class="form-group"> <label>Сумма (₽)</label> <input type="number" id="transferAmount" min="1" step="0.01" required> </div> <div class="form-group"> <label>Комментарий</label> <textarea id="transferComment" rows="3"></textarea> </div> <button type="submit" class="btn btn-primary btn-block">Передать</button> </form> </div> </div>
    <div id="addCategoryModal" class="modal"> <div class="modal-content"> <div class="modal-header"> <h2>📁 Категория</h2> <button class="modal-close" onclick="closeModal('addCategoryModal')">✕</button> </div> <form onsubmit="submitAddCategory(event)"> <div class="form-group"> <label>Категория</label> <input type="text" id="newCategory" required> </div> <div class="form-group"> <label>Подкатегория</label> <input type="text" id="newSubcategory" required> </div> <button type="submit" class="btn btn-primary btn-block">Добавить</button> </form> </div> </div>
    <div class="bottom-nav" id="bottomNav"> <button class="bottom-nav-item" onclick="openModal('requestFundsModal')"> <span class="icon">📥</span> <span>Запросить</span> </button> <button class="bottom-nav-item" onclick="openModal('recordExpenseModal')"> <span class="icon">💸</span> <span>Расход</span> </button> <button class="bottom-nav-item" onclick="openModal('transferFundsModal')"> <span class="icon">↔️</span> <span>Передать</span> </button> <button class="bottom-nav-item" id="bottomNavBalance" style="display: none;" onclick="switchTab('balances')"> <span class="icon">🏦</span> <span>Баланс</span> </button> <button class="bottom-nav-item" id="bottomNavMenu" onclick="openSidebar()"> <span class="icon">☰</span> <span>Меню</span> </button> </div>

    <script>
        // ============================================================================
        // API "МОСТ" 
        // ============================================================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbxztQgwaMKfXVSjubNKK90IYKtbye7N3S-WtMAwn_N7E6PONbAOAtwPUlglmMA0YKjLWQ/exec'; 
        async function callApi(action, payload = {}) { console.log(`🚀 API Call: ${action}`, payload); try { const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action, payload }) }); const responseText = await response.text(); console.log(`📬 API Response (${action}): ${response.status} ${response.statusText}`, responseText); if (!response.ok) { throw new Error(`Network error: ${response.status} ${response.statusText}. Response: ${responseText}`); } let result; try { result = JSON.parse(responseText); } catch (jsonError) { console.error('JSON Parse Error:', jsonError); throw new Error(`Failed to parse server response: ${responseText}`); } if (result.success === false && result.error) { throw new Error(result.error); } console.log(`✅ API Success (${action}):`, result); return result; } catch (error) { console.error(`❌ API Error (${action}):`, error); showAlert(`Критическая ошибка API (${action}): ${error.message}`, 'error'); throw error; } }
        
        // ============================================================================
        // КОНФИГУРАЦИЯ
        // ============================================================================
        let allData = { log: [], balances: [], admin: [] }; let currentTheme = localStorage.getItem('theme') || 'light'; let currentUserId = null; let currentUserRole = 'Загрузка...'; let categoriesData = {};
        function getTelegramUserId() { try { if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) { const d = window.Telegram.WebApp.initDataUnsafe; if (d.user && d.user.id) { console.log('✅ TG User ID:', d.user.id); return String(d.user.id); } else { console.warn('No user.id in initData:', d); } } else { console.log('TG WebApp not found.'); } } catch (e) { console.error('❌ Error getting TG InitData:', e); } const defaultId = '1125736'; console.warn(`⚠️ Using default ID: ${defaultId}`); return defaultId; }
        
        // ============================================================================
        // ИНИЦИАЛИЗАЦИЯ
        // ============================================================================
        document.addEventListener('DOMContentLoaded', function() { const s=document.createElement('script'); s.src='https://telegram.org/js/telegram-web-app.js'; s.async=true; s.onload=()=>{ console.log('✅ TG script loaded.'); if(window.Telegram && window.Telegram.WebApp){ try{window.Telegram.WebApp.ready(); window.Telegram.WebApp.expand(); console.log('TG ready() & expand()');}catch(e){console.error("TG methods error: ", e);}} initializeWebApp(); }; s.onerror=()=>{console.error('❌ TG script failed.'); initializeWebApp();}; document.head.appendChild(s); });
        async function initializeWebApp() { console.log('🚀 App init...'); currentUserId = getTelegramUserId(); localStorage.setItem('userId', currentUserId); console.log('👤 User ID:', currentUserId); applyTheme(currentTheme); await loadData(); setInterval(loadData, 30000); console.log('🏁 Init done.'); }
        
        // ============================================================================
        // SIDEBAR & НАВИГАЦИЯ
        // ============================================================================
        function openSidebar() { document.getElementById('sidebar').classList.add('active'); document.getElementById('sidebarOverlay').classList.add('active'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('active'); document.getElementById('sidebarOverlay').classList.remove('active'); }
        function switchTab(tabName) { document.querySelectorAll('.content').forEach(c => c.classList.remove('active')); document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active')); const c = document.getElementById(tabName), t = document.getElementById('nav-' + tabName); if (c) c.classList.add('active'); if (t) t.classList.add('active'); if (tabName === 'journal') { loadJournal(); } else if (tabName === 'balances') { loadBalances(); } else if (tabName === 'analytics') { loadAnalytics(); } else if (tabName === 'approvals') { loadApprovals(); } else if (tabName === 'received') { loadReceivedMoney(); } else if (tabName === 'transfers') { loadPendingTransfers(); } closeSidebar(); }
        
        // ============================================================================
        // ЗАГРУЗКА ДАННЫХ
        // ============================================================================
        async function loadData() { console.log('📨 Loading data...'); try { const data = await callApi('getData'); console.log('✅ Data received:', data); allData = { log: Array.isArray(data.log)?data.log:[], balances: Array.isArray(data.balances)?data.balances:[], admin: Array.isArray(data.admin)?data.admin:[] }; console.log('💾 Data stored:', allData); checkCategoryManagementAccess(); updateDashboard(); populateSelects(); await loadCategories(); const activeTab = document.querySelector('.nav-tab.active'); if (activeTab) { const name = activeTab.id.replace('nav-', ''); if (name !== 'dashboard') { const func = 'load' + name.charAt(0).toUpperCase() + name.slice(1); if (typeof window[func] === 'function') { window[func](); } else if (name === 'received') { loadReceivedMoney(); } else if (name === 'transfers') { loadPendingTransfers(); } } } } catch (e) { console.error('❌ Critical load error:', e); showAlert('Критическая ошибка: ' + e.message, 'error'); } }
        
        // ============================================================================
        // DASHBOARD (ВКЛЮЧАЯ КАРТОЧКИ И ГРАФИКИ)
        // ============================================================================
        function updateDashboard() { try { const log = allData.log || [], balances = allData.balances || []; console.log('📊 Updating Dashboard for:', currentUserId, currentUserRole); let exp = 0, iss = 0, req = 0, bal = 0, respBal = 0, respId = null; const balRec = balances.find(b => Array.isArray(b) && String(b[0]).trim() === currentUserId); if (balRec) { bal = parseFloat(balRec[2]) || 0; } if (currentUserRole === 'Директор') { const respRec = allData.admin.find(a => Array.isArray(a) && a[1] === 'Ответственный'); if (respRec) { respId = String(respRec[0]).trim(); const rBalRec = balances.find(b => Array.isArray(b) && String(b[0]).trim() === respId); if (rBalRec) { respBal = parseFloat(rBalRec[2]) || 0; } } } const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30); log.forEach(entry => { if (!Array.isArray(entry) || entry.length < 12) return; const type = String(entry[2]||''), status = String(entry[3]||''), amount = parseFloat(entry[4])||0, fromId = String(entry[5]||''), toId = String(entry[6]||''), date = new Date(entry[0]); if ((type === 'Расход' || type === 'Возврат') && fromId === currentUserId) { exp += Math.abs(amount); } if (currentUserRole === 'Директор' || currentUserRole === 'Бухгалтер') { if (type === 'Выдача' && status === 'Подтверждено') { iss += amount; } } else { if (((type === 'Выдача') || (type === 'Передача' && status === 'Подтверждено')) && toId === currentUserId) { iss += amount; } } if (type === 'Запрос' && status === 'Ожидает' && fromId === currentUserId) { req++; } }); document.getElementById('totalExpenses').textContent = formatCurrency(exp); document.getElementById('totalIssued').textContent = formatCurrency(iss); document.getElementById('pendingRequests').textContent = req; document.getElementById('totalBalance').textContent = formatCurrency(bal); const respCard = document.getElementById('responsibleBalanceCard'), respVal = document.getElementById('responsibleBalance'); if (respCard && respVal) { if (currentUserRole === 'Директор' && respId) { respVal.textContent = formatCurrency(respBal); respCard.style.display = 'block'; } else { respCard.style.display = 'none'; } } displayDashboardCharts(); console.log('✅ Dashboard updated.'); } catch(e) { console.error("❌ Error updating Dashboard:", e); showAlert("Ошибка главной: " + e.message, 'error'); } }
        function displayDashboardCharts() { const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30); thirtyDaysAgo.setHours(0,0,0,0); const expensesLast30Days = allData.log.filter(entry => Array.isArray(entry) && entry.length > 8 && entry[2] === 'Расход' && new Date(entry[0]) >= thirtyDaysAgo); const categoryData = aggregateDataByCategory(expensesLast30Days); renderBarChart('categoryChart', categoryData); const trendData = aggregateDataByPeriod(expensesLast30Days, 'daily'); renderBarChart('trendChart', trendData); }
        
        // ============================================================================
        // ОПЕРАЦИИ - ОТПРАВКА ДАННЫХ
        // ============================================================================
        async function submitRequestFunds(event) { event.preventDefault(); const a=document.getElementById('requestAmount'), c=document.getElementById('requestComment'), am=parseFloat(a.value), cm=c.value; if(!am||am<=0){showAlert('Сумма?', 'error'); a.focus(); return;} if(!currentUserId){showAlert('ID?', 'error'); return;} const p={userId:currentUserId, amount:am, comment:cm}, b=event.target.querySelector('button[type="submit"]'); try {b.disabled=true; b.textContent='Отправка...'; const r=await callApi('recordRequestFunds', p); if(r.success){showAlert('✅ Запрос отправлен!','success'); closeModal('requestFundsModal'); a.value=''; c.value=''; await loadData();}else{showAlert('❌ Ошибка: '+(r.error||'?'), 'error');}}catch(e){showAlert('❌ Ошибка запроса: '+e.message, 'error');}finally{b.disabled=false; b.textContent='Отправить';} }
        async function submitRecordExpense(event) { event.preventDefault(); const a=document.getElementById('expenseAmount'), cat=document.getElementById('expenseCategory'), sub=document.getElementById('expenseSubcategory'), c=document.getElementById('expenseComment'), am=parseFloat(a.value), ct=cat.value, sb=sub.value, cm=c.value; if(!am||am<=0){showAlert('Сумма?','error'); a.focus(); return;} if(!ct){showAlert('Категория?','error'); cat.focus(); return;} if(!sb){showAlert('Подкатегория?','error'); sub.focus(); return;} if(!currentUserId){showAlert('ID?','error'); return;} const p={userId:currentUserId, amount:am, category:ct, subcategory:sb, comment:cm}, b=event.target.querySelector('button[type="submit"]'); try {b.disabled=true; b.textContent='Запись...'; const r=await callApi('recordExpense',p); if(r.success){showAlert('✅ Расход записан!','success'); closeModal('recordExpenseModal'); a.value=''; cat.value=''; sub.innerHTML='<option value="">Выбрать...</option>'; c.value=''; await loadData();}else{showAlert('❌ Ошибка: '+(r.error||'?'), 'error');}}catch(e){showAlert('❌ Ошибка расхода: '+e.message, 'error');}finally{b.disabled=false; b.textContent='Записать';} }
        async function submitTransferFunds(event) { event.preventDefault(); const t=document.getElementById('transferTo'), a=document.getElementById('transferAmount'), c=document.getElementById('transferComment'), toId=t.value, am=parseFloat(a.value), cm=c.value; if(!toId){showAlert('Получатель?','error'); t.focus(); return;} if(!am||am<=0){showAlert('Сумма?','error'); a.focus(); return;} if(!currentUserId){showAlert('ID?','error'); return;} if(toId===currentUserId){showAlert('Себе нельзя','warning'); return;} const p={fromId:currentUserId, toId:toId, amount:am, comment:cm}, b=event.target.querySelector('button[type="submit"]'); try {b.disabled=true; b.textContent='Отправка...'; const r=await callApi('recordTransfer',p); if(r.success){showAlert('✅ Запрос отправлен. Ждем подтверждения.','info'); closeModal('transferFundsModal'); t.value=''; a.value=''; c.value=''; await loadData();}else{showAlert('❌ Ошибка: '+(r.error||'?'), 'error');}}catch(e){showAlert('❌ Ошибка перевода: '+e.message, 'error');}finally{b.disabled=false; b.textContent='Передать';} }
        
        // ============================================================================
        // ЖУРНАЛ
        // ============================================================================
        function loadJournal() { try { const l=allData.log||[],t=document.getElementById('journalBody');console.log('📰 Журнал:', l.length); if(l.length===0){t.innerHTML='<tr><td colspan="9" class="empty-state">Нет данных</td></tr>';return;} let h=''; for(let i=l.length-1;i>=0;i--){const e=l[i];if(!Array.isArray(e)||e.length<12){console.warn("Skip:",e);continue;} try{const d=e[0]?new Date(e[0]).toLocaleDateString('ru-RU'):'N/A',id=e[1]||'N/A',tp=e[2]||'?',st=e[3]||'?',am=e[4],fr=e[5]||'',to=e[6]||'',cat=e[8]||'',sub=e[9]||'',com=e[11]||'',cl=st==='Подтверждено'?'status-approved':(st==='Ожидает'?'status-pending':'status-rejected'),fn=getNameById(fr)||fr,tn=getNameById(to)||to; h+=`<tr><td>${d}</td><td><code>${id}</code></td><td>${tp}</td><td><span class="status-badge ${cl}">${st}</span></td><td>${formatCurrency(am)}</td><td>${fn}</td><td>${tn}</td><td>${cat}${sub?' / '+sub:''}</td><td>${com}</td></tr>`;}catch(er){console.error("Row err:",er,e);}} t.innerHTML=h; console.log('✅ Журнал OK.');}catch(e){console.error("❌ Журнал err:",e);showAlert("Ошибка журнала: "+e.message,'error');}}
        function applyFilters() { try { const l=allData.log||[],dF=document.getElementById('filterDateFrom').value,dT=document.getElementById('filterDateTo').value,tp=document.getElementById('filterType').value,st=document.getElementById('filterStatus').value,df=dF?new Date(dF+'T00:00:00'):null,dt=dT?new Date(dT+'T23:59:59'):null; console.log('🔍 Фильтры:',{df,dt,tp,st}); const t=document.getElementById('journalBody'); let h='',c=0; for(let i=l.length-1;i>=0;i--){const e=l[i];if(!Array.isArray(e)||e.length<12)continue; try{const ed=e[0]?new Date(e[0]):null;if(!ed)continue; const et=String(e[2]||''),es=String(e[3]||''); let m=true; if(df&&ed<df)m=false; if(dt&&ed>dt)m=false; if(tp&&et!==tp)m=false; if(st&&es!==st)m=false; if(m){c++; const ds=ed.toLocaleDateString('ru-RU'),id=e[1]||'N/A',am=e[4],fr=e[5]||'',to=e[6]||'',cat=e[8]||'',sub=e[9]||'',com=e[11]||'',cl=es==='Подтверждено'?'status-approved':(es==='Ожидает'?'status-pending':'status-rejected'),fn=getNameById(fr)||fr,tn=getNameById(to)||to; h+=`<tr><td>${ds}</td><td><code>${id}</code></td><td>${et}</td><td><span class="status-badge ${cl}">${es}</span></td><td>${formatCurrency(am)}</td><td>${fn}</td><td>${tn}</td><td>${cat}${sub?' / '+sub:''}</td><td>${com}</td></tr>`;}}catch(er){console.error("Filter row err:",er,e);}} t.innerHTML=h||`<tr><td colspan="9" class="empty-state">Нет данных (${c})</td></tr>`; console.log(`✅ Фильтры: ${c}.`);}catch(e){console.error("❌ Фильтры err:",e);showAlert("Ошибка фильтров: "+e.message,'error');}}
        function resetFilters() { document.getElementById('filterDateFrom').value=''; document.getElementById('filterDateTo').value=''; document.getElementById('filterType').value=''; document.getElementById('filterStatus').value=''; loadJournal(); console.log('Фильтры сброшены.'); }
        function exportToCSV() { /* ... Код экспорта ... */ }
        
        // ============================================================================
        // БАЛАНСЫ
        // ============================================================================
        function loadBalances() { try { const b=allData.balances||[],c=document.getElementById('balancesList');console.log('💵 Балансы:', b.length); if(b.length===0){c.innerHTML='<div class="empty-state">Нет данных</div>';return;} let h=''; b.forEach(i=>{if(!Array.isArray(i)||i.length<3){console.warn("Skip balance:",i);return;} const id=i[0],n=i[1]||'?',v=parseFloat(i[2])||0,cl=v>=0?'positive':'negative'; h+=`<div class="balance-item"><div class="balance-item-info"><h4>${n}</h4><p>ID: ${id}</p></div><div class="balance-item-value ${cl}">${formatCurrency(v)}</div></div>`;}); c.innerHTML=h; console.log('✅ Балансы OK.');}catch(e){console.error("❌ Балансы err:",e);showAlert("Ошибка балансов: "+e.message,'error');}}
        
        // ============================================================================
        // "ПОЛУЧЕНО"
        // ============================================================================
        function loadReceivedMoney() { const c=document.getElementById('received');if(!c)return; console.log('💰 Загрузка получено...'); try { const l=allData.log||[],n=new Date(),f=new Date(n.getFullYear(),n.getMonth(),1); let t=0; l.forEach(e=>{if(!Array.isArray(e)||e.length<7)return; const d=new Date(e[0]),tp=String(e[2]||''),st=String(e[3]||''),to=String(e[6]||''),am=parseFloat(e[4])||0; if(st==='Подтверждено'&&to===currentUserId&&(tp==='Выдача'||tp==='Передача')&&d>=f){t+=am;}}); console.log(`✅ Получено: ${t}`); c.innerHTML=`<h2 style="margin-bottom: 20px;">💰 Получено в этом месяце</h2><div class="cards-grid"><div class="card positive" style="grid-column: 1 / -1;"><h3>Всего получено</h3><div class="value">${formatCurrency(t)}</div></div></div><div class="chart-container"><h3>График</h3><div class="chart">График здесь...</div></div>`;}catch(e){console.error("❌ 'Получено' err:",e);c.innerHTML='<div class="empty-state">Ошибка.</div>';}}
        
        // ============================================================================
        // "ВХОДЯЩИЕ"
        // ============================================================================
        function loadPendingTransfers() { const c=document.getElementById('transfers');if(!c)return; console.log('➡️ Загрузка входящих...'); try { const l=allData.log||[],p=l.filter(e=>Array.isArray(e)&&e.length>12&&e[2]==='Передача'&&e[3]==='Ожидает'&&String(e[6]||'')===currentUserId); if(p.length===0){c.innerHTML=`<h2 style="margin-bottom: 20px;">➡️ Входящие</h2><div class="empty-state">Нет ожидающих</div>`;return;} let h=`<h2 style="margin-bottom: 20px;">➡️ Входящие</h2><div class="table-container"><table id="pendingTransfersTable"><thead><tr><th>Дата</th><th>ID</th><th>От кого</th><th>Сумма</th><th>Комментарий</th><th>Действие</th></tr></thead><tbody>`; p.sort((a,b)=>new Date(b[0])-new Date(a[0])); p.forEach(e=>{const id=e[1]||'N/A',fr=String(e[5]||''),fn=getNameById(fr),am=e[4],d=e[0]?new Date(e[0]).toLocaleDateString('ru-RU'):'N/A',com=e[11]||''; h+=`<tr><td>${d}</td><td><code>${id}</code></td><td>${fn}</td><td>${formatCurrency(am)}</td><td>${com}</td><td><button class="btn btn-success btn-small" onclick="approveTransfer('${id}')">🤝</button> <button class="btn btn-danger btn-small" onclick="rejectTransfer('${id}')">⛔</button></td></tr>`;}); h+=`</tbody></table></div>`; c.innerHTML=h;}catch(e){console.error("❌ 'Входящие' err:",e);c.innerHTML='<div class="empty-state">Ошибка.</div>';}}
        async function approveTransfer(id) { console.log(`🤝 Принять: ${id}`); const p={transferId:id, userId:currentUserId},ab=document.querySelector(`button[onclick="approveTransfer('${id}')"]`),rb=document.querySelector(`button[onclick="rejectTransfer('${id}')"]`); try { if(ab)ab.disabled=true; if(rb)rb.disabled=true; const r=await callApi('approveTransfer',p); if(r.success){showAlert('✅ Принято!','success'); await loadData(); loadPendingTransfers();}else{showAlert('❌ Ошибка: '+(r.error||'?'),'error'); if(ab)ab.disabled=false; if(rb)rb.disabled=false;}}catch(e){showAlert('❌ Ошибка сети: '+e.message,'error'); if(ab)ab.disabled=false; if(rb)rb.disabled=false;}}
        async function rejectTransfer(id) { console.log(`⛔ Отклонить: ${id}`); const p={transferId:id, userId:currentUserId},ab=document.querySelector(`button[onclick="approveTransfer('${id}')"]`),rb=document.querySelector(`button[onclick="rejectTransfer('${id}')"]`); try { if(ab)ab.disabled=true; if(rb)rb.disabled=true; const r=await callApi('rejectTransfer',p); if(r.success){showAlert('✅ Отклонено!','success'); await loadData(); loadPendingTransfers();}else{showAlert('❌ Ошибка: '+(r.error||'?'),'error'); if(ab)ab.disabled=false; if(rb)rb.disabled=false;}}catch(e){showAlert('❌ Ошибка сети: '+e.message,'error'); if(ab)ab.disabled=false; if(rb)rb.disabled=false;}}
        
        // ============================================================================
        // АНАЛИТИКА (ВКЛЮЧАЯ ГРАФИКИ)
        // ============================================================================
        function loadAnalytics() { const period=document.getElementById('analyticsPeriod').value, monthsBack=parseInt(document.getElementById('analyticsMonths').value), employeeIdFromFilter=document.getElementById('analyticsEmployee').value, analyticsEmployeeSelect=document.getElementById('analyticsEmployee'); let finalEmployeeId=employeeIdFromFilter; if(currentUserRole==='Сотрудник'){finalEmployeeId=currentUserId; if(analyticsEmployeeSelect){analyticsEmployeeSelect.value=currentUserId; analyticsEmployeeSelect.disabled=true;}}else{if(analyticsEmployeeSelect){analyticsEmployeeSelect.disabled=false;}} console.log('📈 Аналитика:', {period, monthsBack, employeeId:finalEmployeeId}); const endDate=new Date(), startDate=new Date(); startDate.setMonth(startDate.getMonth()-monthsBack); startDate.setDate(1); startDate.setHours(0,0,0,0); const filteredLogs=allData.log.filter(e=>{if(!Array.isArray(e)||e.length<12)return false; const d=new Date(e[0]), t=String(e[2]||''), f=String(e[5]||''); if(!(d>=startDate&&d<=endDate))return false; if(t!=='Расход')return false; if(finalEmployeeId&&f!==finalEmployeeId)return false; return true;}); console.log(`📊 Записей: ${filteredLogs.length}`); const categoryData=aggregateDataByCategory(filteredLogs); renderBarChart('analyticsCategoryChart', categoryData); const employeeData=aggregateDataByEmployee(filteredLogs); renderBarChart('analyticsEmployeeChart', employeeData); const trendData=aggregateDataByPeriod(filteredLogs, period); renderBarChart('analyticsTrendChart', trendData); }
        function aggregateDataByCategory(logs) { const agg={}; logs.forEach(e=>{const c=String(e[8]||'Без кат.').trim(), a=parseFloat(e[4])||0; if(a>0){agg[c]=(agg[c]||0)+a;}}); return Object.entries(agg).map(([label, value])=>({label, value})).sort((a,b)=>b.value-a.value); }
        function aggregateDataByEmployee(logs) { const agg={}; logs.forEach(e=>{const id=String(e[5]||'?').trim(), a=parseFloat(e[4])||0; if(a>0){const n=getNameById(id); agg[n]=(agg[n]||0)+a;}}); return Object.entries(agg).map(([label, value])=>({label, value})).sort((a,b)=>b.value-a.value); }
        function aggregateDataByPeriod(logs, periodType) { const agg={}; logs.forEach(e=>{const d=new Date(e[0]), a=parseFloat(e[4])||0; if(a<=0)return; let k=''; if(periodType==='daily'){k=d.toLocaleDateString('ru-RU');}else if(periodType==='weekly'){const s=new Date(d), day=s.getDay(), diff=s.getDate()-day+(day===0?-6:1); s.setDate(diff); k=s.toLocaleDateString('ru-RU');}else if(periodType==='monthly'){k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;}else{k=String(d.getFullYear());} agg[k]=(agg[k]||0)+a;}); const keys=Object.keys(agg).sort((a,b)=>{if(periodType==='daily'||periodType==='weekly'){const dA=a.split('.').reverse().join(''), dB=b.split('.').reverse().join(''); return dA.localeCompare(dB);} return a.localeCompare(b);}); return keys.map(key=>({label:key, value:agg[key]})); }
        function renderBarChart(containerId, data) { const c=document.getElementById(containerId); if(!c)return; if(!data||data.length===0){c.innerHTML='<div class="empty-state-text" style="padding:20px;">Нет данных</div>';return;} const maxV=Math.max(...data.map(i=>i.value)); if(maxV<=0){c.innerHTML='<div class="empty-state-text" style="padding:20px;">Нет данных</div>';return;} let h='<div class="chart-bars">'; data.forEach(i=>{const hp=(i.value/maxV)*100, dl=i.label.length>10?i.label.substring(0,7)+'...':i.label; h+=`<div class="chart-bar-item" title="${i.label}: ${formatCurrency(i.value)}"><div class="value">${formatCurrency(i.value)}</div><div class="bar" style="height:${hp}%;"></div><div class="label">${dl}</div></div>`;}); h+='</div>'; c.innerHTML=h; }
        
        // ============================================================================
        // ПОДТВЕРЖДЕНИЯ
        // ============================================================================
        function getRoleById(id) { const a=allData.admin||[]; for(let i=0;i<a.length;i++){if(Array.isArray(a[i])&&String(a[i][0]).trim()===String(id).trim()){return a[i][1]||'?';}} return '?'; }
        function loadApprovals() { try { const l=allData.log||[],t=document.getElementById('approvalsBody'); const p=l.filter(e=>Array.isArray(e)&&e.length>12&&e[2]==='Запрос'&&e[3]==='Ожидает'); let h='',c=0; p.forEach(e=>{const id=e[1]||'N/A',reqId=String(e[5]||''),reqRole=getRoleById(reqId),reqName=getNameById(reqId),am=e[4],d=e[0]?new Date(e[0]).toLocaleDateString('ru-RU'):'N/A',com=e[11]||''; let show=false; if(currentUserRole==='Ответственный'&&reqRole==='Сотрудник'){show=true;}else if((currentUserRole==='Директор'||currentUserRole==='Бухгалтер')&&reqRole==='Ответственный'){show=true;} if(show){c++; let btns=''; if(reqId===currentUserId){btns='<i>(Ваш)</i>';}else{btns=`<button class="btn btn-success btn-small" onclick="approveRequest('${id}')">✅</button> <button class="btn btn-danger btn-small" onclick="rejectRequest('${id}')">❌</button>`;} h+=`<tr><td>${d}</td><td><code>${id}</code></td><td>${reqName}(${reqRole})</td><td>${formatCurrency(am)}</td><td><span class="status-badge status-pending">Ожидает</span></td><td>${com}</td><td>${btns}</td></tr>`;}}); if(c===0){t.innerHTML='<tr><td colspan="7" class="empty-state">Нет запросов</td></tr>';}else{t.innerHTML=h;} console.log(`✅ Подтверждения: ${c}.`);}catch(e){console.error("❌ Подтверждения err:",e);showAlert("Ошибка подтверждений: "+e.message,'error');}}
        async function approveRequest(id) { console.log(`👍 Запрос: ${id}`); const p={requestId:id},ab=document.querySelector(`button[onclick="approveRequest('${id}')"]`),rb=document.querySelector(`button[onclick="rejectRequest('${id}')"]`); try { if(ab)ab.disabled=true; if(rb)rb.disabled=true; const r=await callApi('approveRequestWeb',p); if(r.success){showAlert('✅ OK!','success'); await loadData(); if(document.getElementById('approvals').classList.contains('active')){loadApprovals();}}else{showAlert('❌ Ошибка: '+(r.error||'?'),'error'); if(ab)ab.disabled=false; if(rb)rb.disabled=false;}}catch(e){showAlert('❌ Ошибка сети: '+e.message,'error'); if(ab)ab.disabled=false; if(rb)rb.disabled=false;}}
        async function rejectRequest(id) { console.log(`👎 Запрос: ${id}`); const p={requestId:id},ab=document.querySelector(`button[onclick="approveRequest('${id}')"]`),rb=document.querySelector(`button[onclick="rejectRequest('${id}')"]`); try { if(ab)ab.disabled=true; if(rb)rb.disabled=true; const r=await callApi('rejectRequestWeb',p); if(r.success){showAlert('✅ Отклонен!','success'); await loadData(); if(document.getElementById('approvals').classList.contains('active')){loadApprovals();}}else{showAlert('❌ Ошибка: '+(r.error||'?'),'error'); if(ab)ab.disabled=false; if(rb)rb.disabled=false;}}catch(e){showAlert('❌ Ошибка сети: '+e.message,'error'); if(ab)ab.disabled=false; if(rb)rb.disabled=false;}}
        
        // ============================================================================
        // МОДАЛИ
        // ============================================================================
        function openModal(id) { const m=document.getElementById(id); if(m) m.classList.add('active'); }
        function closeModal(id) { const m=document.getElementById(id); if(m) m.classList.remove('active'); }
        
        // ============================================================================
        // ВСПОМОГАТЕЛЬНЫЕ
        // ============================================================================
        function getNameById(id) { if (!id) return ''; const a=allData.admin||[]; for(let i=0;i<a.length;i++){if(Array.isArray(a[i])&&String(a[i][0]).trim()===String(id).trim()){return a[i][2]||`ID:${id}`;}} return `ID:${id}`; }
        function formatCurrency(v) { const n=parseFloat(v); if(isNaN(n)){return 'N/A ₽';} return new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB',minimumFractionDigits:0,maximumFractionDigits:2}).format(n); }
        function populateSelects() { try { const a=allData.admin||[]; console.log('👥 Select:', a.length); let o='<option value="">Выбрать...</option>', ao='<option value="">Все</option>', c=0; a.forEach(p=>{if(!Array.isArray(p)||p.length<4){console.warn("Skip admin:",p);return;} const id=String(p[0]).trim(), n=p[2]||`ID:${id}`, s=String(p[3]||'').trim().toLowerCase(); if(s==='active'){o+=`<option value="${id}">${n}</option>`; ao+=`<option value="${id}">${n}</option>`; c++;}}); const ts=document.getElementById('transferTo'), as=document.getElementById('analyticsEmployee'); if(ts)ts.innerHTML=o; if(as)as.innerHTML=ao; console.log(`✅ Select: ${c}.`);}catch(e){console.error("❌ Select err:",e);showAlert("Ошибка списка: "+e.message,'error');}}
        async function loadCategories() { console.log('📁 Категории...'); try { const c=await callApi('getAllCategories'); console.log('✅ Категории:', c); if(typeof c==='object'&&c!==null){categoriesData=c; updateCategorySelect();}else{console.error('❌ Формат категорий:',c); categoriesData={}; updateCategorySelect(); showAlert('Ошибка загрузки категорий.','error');}}catch(e){console.error('❌ Категории err:',e); showAlert('❌ Категории: '+e.message,'error'); categoriesData={}; updateCategorySelect();}}
        function updateCategorySelect() { try { const s=document.getElementById('expenseCategory'); if(!s)return; let o='<option value="">Выбрать...</option>'; const k=Object.keys(categoriesData||{}); console.log('🔄 Категории:', k); k.sort().forEach(c=>{o+=`<option value="${c}">${c}</option>`;}); s.innerHTML=o; updateSubcategories(); console.log('✅ Select кат. OK.');}catch(e){console.error("❌ Select кат. err:",e);showAlert("Ошибка кат.: "+e.message,'error');}}
        function updateSubcategories() { try { const cs=document.getElementById('expenseCategory'), ss=document.getElementById('expenseSubcategory'); if(!cs||!ss)return; const sc=cs.value; let o='<option value="">Выбрать...</option>'; console.log(`🔄 Подкатегории для "${sc}"`); if(sc&&categoriesData&&Array.isArray(categoriesData[sc])){categoriesData[sc].sort().forEach(s=>{o+=`<option value="${s}">${s}</option>`;});} ss.innerHTML=o; console.log('✅ Select подкат. OK.');}catch(e){console.error("❌ Select подкат. err:",e);showAlert("Ошибка подкат.: "+e.message,'error');}}
        
        // ГЛАВНАЯ ФУНКЦИЯ УПРАВЛЕНИЯ UI (С ИСПРАВЛЕННЫМ ОТСТУПОМ)
        function checkCategoryManagementAccess() {
            const admin = allData.admin || []; let roleFound = false; currentUserRole = 'Не авторизован'; console.log(`🔐 Проверка прав для ID: ${currentUserId}`);
            for (let i=0; i<admin.length; i++) { if (Array.isArray(admin[i]) && String(admin[i][0]).trim() === String(currentUserId).trim()) { currentUserRole = admin[i][1] || 'Не определена'; roleFound = true; console.log(`👤 Роль: ${currentUserRole}`); break; } } if (!roleFound) { console.warn(`👤 Роль для ID ${currentUserId} не найдена.`); }
            const ht=document.getElementById('headerTitle'), urs=document.getElementById('userRole'), addBtn=document.getElementById('addCategoryBtn'), bn=document.getElementById('bottomNav'), cw=document.getElementById('contentWrapper'), body=document.body, bnm=document.getElementById('bottomNavMenu'), bnb=document.getElementById('bottomNavBalance'), nj=document.getElementById('nav-journal'), nt=document.getElementById('nav-transfers'), nbl=document.getElementById('nav-balances'), na=document.getElementById('nav-approvals'), nr=document.getElementById('nav-received'), rc=document.getElementById('responsibleBalanceCard');
            if(ht) ht.textContent=currentUserRole; if(urs) urs.textContent='Роль: '+currentUserRole; body.classList.remove('director-desktop'); 
            
            // --- Управление видимостью Bottom Nav и отступом контента ---
            let isBnVisible = false; 
            const allowedRolesBottomNav = ['Сотрудник', 'Ответственный', 'Директор']; 

            if(bn && cw) { 
                if (roleFound && allowedRolesBottomNav.includes(currentUserRole)) { 
                    bn.style.display = 'flex'; 
                    isBnVisible = true;
                } else { 
                    bn.style.display = 'none'; 
                } 
                // ИЗМЕНЕНИЕ: Устанавливаем margin-bottom = высоте панели (без safe-area, т.к. панель уже поднята)
                cw.style.marginBottom = isBnVisible ? 'var(--bottom-nav-height)' : '0'; 
                console.log(`📱 Отступ контента: ${cw.style.marginBottom}`); 
            } else { console.error("Не найден #bottomNav или #contentWrapper!"); if(cw) cw.style.marginBottom = '0'; }
            
            // --- Сброс видимости кнопок/вкладок ---
            if(bnm)bnm.style.display='flex'; if(nj)nj.style.display='flex'; if(nt)nt.style.display='flex'; if(nbl)nbl.style.display='flex'; if(na)na.style.display='flex'; if(nr)nr.style.display='none'; if(bnb)bnb.style.display='none'; if(rc)rc.style.display='none'; 
            // --- Исключения для "Сотрудника" ---
            if (currentUserRole === 'Сотрудник') { console.log('👤 UI Сотрудник'); if(nj)nj.style.display='none'; if(na)na.style.display='none'; if(nr)nr.style.display='flex'; if(nbl)nbl.style.display='none'; if(bnb)bnb.style.display='flex'; if(bnm)bnm.style.display='none'; } 
            // --- Исключения для "Директора" ---
            else if (currentUserRole === 'Директор') { console.log('👤 UI Директор'); if(rc)rc.style.display='block'; }
            // --- Кнопка "Добавить категорию" ---
            const allowedAdd = ['Директор','Бухгалтер','Ответственный']; if (addBtn) { const canAdd = allowedAdd.includes(currentUserRole); addBtn.style.display=canAdd?'inline-block':'none'; console.log(`🔧 Кнопка '+': ${canAdd?'OK':'X'}.`); }
        }

        async function submitAddCategory(event) { event.preventDefault(); const ci=document.getElementById('newCategory'), si=document.getElementById('newSubcategory'), c=ci.value.trim(), s=si.value.trim(); if(!c||!s){showAlert('Заполните поля','error'); if(!c)ci.focus(); else si.focus(); return;} const p={category:c, subcategory:s}, b=event.target.querySelector('button[type="submit"]'); try {b.disabled=true; b.textContent='Добавление...'; const r=await callApi('addCategoryToSheet',p); if(r.success){showAlert('✅ OK!','success'); closeModal('addCategoryModal'); ci.value=''; si.value=''; await loadCategories();}else{showAlert(`❌ Ошибка: ${r.error||'?'}`, 'error');}}catch(e){showAlert('❌ Ошибка сети: '+e.message,'error');}finally{b.disabled=false; b.textContent='Добавить';}}
        function showAlert(msg, type='info') { const id=type+'Alert', el=document.getElementById(id); if(!el)return; if(el.timerId){clearTimeout(el.timerId);} el.textContent=msg; el.classList.add('active'); el.timerId=setTimeout(()=>{el.classList.remove('active'); el.timerId=null;}, 5000); }
        
        // ============================================================================
        // ТЕМА И ЗАКРЫТИЕ МОДАЛЕЙ
        // ============================================================================
        function toggleTheme() { currentTheme=currentTheme==='light'?'dark':'light'; localStorage.setItem('theme', currentTheme); applyTheme(currentTheme); const b=document.querySelector('.theme-toggle'); if(b){b.textContent=currentTheme==='light'?'🌙 Темная':'☀️ Светлая';}}
        function applyTheme(theme) { if(theme==='dark'){document.body.classList.add('dark-theme');}else{document.body.classList.remove('dark-theme');} console.log(`🎨 Тема: ${theme}`); const b=document.querySelector('.theme-toggle'); if(b){b.textContent=theme==='light'?'🌙 Темная':'☀️ Светлая';}}
        window.onclick = function(event) { if(event.target.classList.contains('modal')){document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));}}
    </script>
</body>
</html>