<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>–°–∏—Å—Ç–µ–º–∞ –£—á–µ—Ç–∞ –†–∞—Å—Ö–æ–¥–æ–≤</title>
    <style>
        /* ============================================================================ */
        /* –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò –ú–ê–ö–ï–¢–ê */
        /* ============================================================================ */
        :root {
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --header-height: 60px;
            --bottom-nav-height: 60px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–∞–Ω–µ–ª–∏ */
            --sidebar-width: 280px; 
            --chart-bar-color: #667eea; 
            --chart-label-color: #555;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-overflow-scrolling: touch; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        
        /* –û–ë–ï–†–¢–ö–ê –ö–û–ù–¢–ï–ù–¢–ê: –£–ø—Ä–∞–≤–ª—è–µ–º padding-bottom —á–µ—Ä–µ–∑ JS */
        .content-wrapper { 
             padding-top: calc(var(--header-height) + var(--safe-area-top)); 
             /* –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º padding-bottom –≤–º–µ—Å—Ç–æ margin-bottom */
             padding-bottom: 0; /* –£–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è JS */
             margin-bottom: 0; /* –£–±—Ä–∞–Ω */
             transition: padding-bottom 0.3s ease; /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ */
             min-height: calc(100vh - (var(--header-height) + var(--safe-area-top))); 
             display: flex; 
             flex-direction: column;
        }
        .container { max-width: 100%; margin: 0 auto; background: white; flex-grow: 1; }

        /* HEADER */
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0 15px; display: flex; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: calc(var(--header-height) + var(--safe-area-top)); padding-top: var(--safe-area-top); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header h1 { font-size: 20px; font-weight: 600; }
        
        /* SIDEBAR */
        .sidebar { position: fixed; top: 0; right: 0; left: auto; width: var(--sidebar-width); height: 100%; background: #f8f9fa; z-index: 1002; transform: translateX(100%); transition: transform 0.3s ease-out; box-shadow: -4px 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .sidebar.active { transform: translateX(0); }
        .sidebar-header { padding: 20px; padding-top: calc(var(--safe-area-top) + 20px); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .sidebar-header .user-info { margin-bottom: 15px; } .user-info span { font-size: 16px; font-weight: 500; opacity: 0.9; }
        .theme-toggle { background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background 0.3s; } .theme-toggle:hover { background: rgba(255, 255, 255, 0.3); }
        .sidebar-nav { display: flex; flex-direction: column; flex: 1; overflow-y: auto; }
        .nav-tab { width: 100%; padding: 16px 20px; cursor: pointer; background: #f8f9fa; border: none; font-size: 16px; font-weight: 500; color: #666; transition: all 0.3s; border-bottom: 1px solid #e9ecef; border-right: 4px solid transparent; border-left: none; display: flex; align-items: center; text-align: left; }
        .nav-tab .icon { font-size: 20px; margin-right: 15px; width: 24px; display: inline-block; text-align: center; color: #555; }
        .nav-tab:hover { background: #e9ecef; color: #333; } .nav-tab.active { background: white; color: #667eea; border-right-color: #667eea; } .nav-tab.active .icon { color: #667eea; }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; } .sidebar-overlay.active { opacity: 1; visibility: visible; }

        /* ============================================================================ */
        /* BOTTOM NAV (–ò–°–ü–†–ê–í–õ–ï–ù–û - –ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥) */
        /* ============================================================================ */
        .bottom-nav { 
            position: fixed; 
            /* –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–∏–∂–∏–º–∞–µ–º –∫ —Å–∞–º–æ–º—É –Ω–∏–∑—É */
            bottom: 0; 
            left: 0; 
            right: 0; 
            z-index: 100; 
            background: #f8f9fa; 
            border-top: 1px solid #e9ecef; 
            box-shadow: 0 -4px 15px rgba(0,0,0,0.05); 
            display: none; /* JS —É–ø—Ä–∞–≤–ª—è–µ—Ç */
            /* –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í—ã—Å–æ—Ç–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–Ω–æ–π —á–∞—Å—Ç–∏ */
            height: var(--bottom-nav-height); 
            /* –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û—Ç—Å—Ç—É–ø *–≤–Ω—É—Ç—Ä–∏* –ø–∞–Ω–µ–ª–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
            padding-bottom: var(--safe-area-bottom); 
            /* –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ padding –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ –≤—ã—Å–æ—Ç–µ */
            box-sizing: content-box; 
        }
        .bottom-nav-item { background: none; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; 
            /* –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í—ã—Å–æ—Ç–∞ –∫–Ω–æ–ø–∫–∏ = –≤—ã—Å–æ—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç–Ω–æ–π —á–∞—Å—Ç–∏ –ø–∞–Ω–µ–ª–∏ */
            height: var(--bottom-nav-height); 
            font-size: 10px; color: #666; transition: background 0.3s; padding: 5px 0; }
        .bottom-nav-item:hover { background: #e9ecef; } .bottom-nav-item .icon { font-size: 24px; margin-bottom: 2px; }
        
        /* DARK THEME */
        body.dark-theme { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); } body.dark-theme .container { background: #0f3460; color: #e0e0e0; } body.dark-theme .sidebar { background: #1a1a2e; } body.dark-theme .sidebar-header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); } body.dark-theme .nav-tab { background: #1a1a2e; color: #999; border-bottom-color: #16213e; } body.dark-theme .nav-tab .icon { color: #888; } body.dark-theme .nav-tab:hover { background: #16213e; color: #ccc; } body.dark-theme .nav-tab.active { background: #0f3460; color: #667eea; } body.dark-theme .nav-tab.active .icon { color: #667eea; } body.dark-theme .bottom-nav { background: #1a1a2e; border-top-color: #16213e; } body.dark-theme .bottom-nav-item { color: #999; } body.dark-theme .bottom-nav-item:hover { background: #16213e; } body.dark-theme .form-container, body.dark-theme .filters { background: #1a1a2e; } body.dark-theme .form-group input, body.dark-theme .form-group select, body.dark-theme .form-group textarea, body.dark-theme .filter-group input, body.dark-theme .filter-group select { background: #16213e; border-color: #16213e; color: #e0e0e0; } body.dark-theme table { background: #1a1a2e; } body.dark-theme thead { background: #16213e; border-bottom-color: #16213e; } body.dark-theme th { color: #e0e0e0; } body.dark-theme td { color: #e0e0e0; border-bottom-color: #16213e; } body.dark-theme tbody tr:hover { background: #16213e; } body.dark-theme .chart-container { background: #1a1a2e; border-color: #16213e; color: #e0e0e0; } 
        body.dark-theme .chart { background: #16213e; color: #bbb; } body.dark-theme .chart .bar { background-color: #7f8dde; } body.dark-theme .chart .label { color: #aaa; } body.dark-theme .chart .value { color: #ddd; }
        body.dark-theme .balance-item { background: #1a1a2e; border-color: #16213e; } body.dark-theme .balance-item-info h4 { color: #e0e0e0; } body.dark-theme .btn-secondary { background: #16213e; color: #e0e0e0; } body.dark-theme .btn-secondary:hover { background: #0f3460; } body.dark-theme .modal-content { background: #0f3460; color: #e0e0e0; } body.dark-theme .modal-header { border-bottom-color: #16213e; } body.dark-theme .modal-header h2 { color: #e0e0e0; } body.dark-theme .form-group label { color: #e0e0e0; }

        /* CONTENT STYLES */
        .content { padding: 20px; display: none; } .content.active { display: block; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 25px; } 
        .card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); } 
        .card h3 { font-size: 12px; opacity: 0.9; margin-bottom: 5px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } 
        .card .value { font-size: 20px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } 
        .card.positive { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); } .card.negative { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); } .card.info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .form-container { background: #f8f9fa; padding: 30px; border-radius: 12px; margin-bottom: 20px; } .form-group { margin-bottom: 20px; } .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px; } .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit; transition: all 0.3s; } .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; display: inline-block; } .btn-primary { background: #667eea; color: white; } .btn-primary:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); } .btn-success { background: #11998e; color: white; } .btn-success:hover { background: #0d7a6a; } .btn-danger { background: #eb3349; color: white; } .btn-danger:hover { background: #d42a3d; } .btn-secondary { background: #e9ecef; color: #333; } .btn-secondary:hover { background: #dee2e6; } .btn-small { padding: 8px 16px; font-size: 12px; } .btn-block { width: 100%; display: block; }
        .filters { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; } .filter-group { display: flex; flex-direction: column; } .filter-group label { font-size: 12px; font-weight: 600; color: #666; margin-bottom: 5px; text-transform: uppercase; } .filter-group input, .filter-group select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit; } .filter-group input:focus, .filter-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); } .filter-buttons { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #e9ecef; } table { width: 100%; border-collapse: collapse; background: white; } thead { background: #f8f9fa; border-bottom: 2px solid #e9ecef; } th { padding: 15px; text-align: left; font-weight: 600; color: #333; font-size: 13px; text-transform: uppercase; } td { padding: 15px; border-bottom: 1px solid #e9ecef; font-size: 14px; } tbody tr:hover { background: #f8f9fa; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; } .status-approved { background: #d4edda; color: #155724; } .status-pending { background: #fff3cd; color: #856404; } .status-rejected { background: #f8d7da; color: #721c24; }
        .chart-container { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e9ecef; margin-bottom: 20px; } .chart-container h3 { margin-bottom: 20px; color: #333; font-size: 16px; }
        .chart { width: 100%; min-height: 250px; background: #f8f9fa; border-radius: 8px; display: flex; flex-direction: column; padding: 20px; color: #999; font-size: 14px; overflow-x: auto; } .chart-bars { display: flex; align-items: flex-end; height: 180px; border-bottom: 1px solid #ddd; margin-bottom: 10px; gap: 5px; } .chart-bar-item { flex: 1; display: flex; flex-direction: column; align-items: center; text-align: center; min-width: 40px; } .chart .bar { width: 80%; background-color: var(--chart-bar-color); border-radius: 4px 4px 0 0; transition: height 0.3s ease; } .chart .value { font-size: 10px; color: var(--chart-label-color); margin-top: 3px; font-weight: bold; white-space: nowrap; } .chart .label { font-size: 10px; color: var(--chart-label-color); margin-top: 5px; white-space: nowrap; transform: rotate(-45deg); transform-origin: top right; }
        .balance-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; } .balance-item { background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 20px; display: flex; justify-content: space-between; align-items: center; } .balance-item-info h4 { font-size: 16px; color: #333; margin-bottom: 5px; } .balance-item-info p { font-size: 12px; color: #999; } .balance-item-value { font-size: 24px; font-weight: 700; text-align: right; } .balance-item-value.positive { color: #11998e; } .balance-item-value.negative { color: #eb3349; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); animation: fadeIn 0.3s; } .modal.active { display: flex; align-items: center; justify-content: center; } .modal-content { background-color: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); animation: slideIn 0.3s; } .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e9ecef; } .modal-header h2 { font-size: 20px; color: #333; } .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; } .modal-close:hover { color: #333; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } } @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .alert { padding: 15px; margin-bottom: 20px; border-radius: 6px; display: none; animation: slideIn 0.3s; } .alert.active { display: block; } .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; } .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; } .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; } .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .loading { text-align: center; padding: 40px; color: #999; } .spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; } .empty-state-icon { font-size: 64px; margin-bottom: 20px; } .empty-state-text { font-size: 16px; margin-bottom: 10px; }
        @media (max-width: 768px) { .filters { grid-template-columns: 1fr; } .modal-content { width: 95%; } .balance-list { grid-template-columns: 1fr; } }
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; } .action-card { flex: 1; min-width: 150px; padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; } .action-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); } .action-card-icon { font-size: 32px; margin-bottom: 10px; } .action-card-title { font-weight: 600; font-size: 14px; } .action-card.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; } .action-card.success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; } .action-card.warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
    </style>
</head>
<body class=""> 
    <div class="header"> <h1 id="headerTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h1> </div>
    <div class="sidebar" id="sidebar"> <div class="sidebar-header"> <div class="user-info"> <span id="userRole">–†–æ–ª—å: –ó–∞–≥—Ä—É–∑–∫–∞...</span> </div> <button class="theme-toggle" onclick="toggleTheme()">üåô –¢–µ–º–Ω–∞—è</button> </div> <div class="sidebar-nav"> <button class="nav-tab active" id="nav-dashboard" onclick="switchTab('dashboard')"><span class="icon">üè†</span> <span>–ì–ª–∞–≤–Ω–∞—è</span></button> <button class="nav-tab" id="nav-operations" onclick="switchTab('operations')"><span class="icon">üí≥</span> <span>–û–ø–µ—Ä–∞—Ü–∏–∏</span></button> <button class="nav-tab" id="nav-received" onclick="switchTab('received')" style="display: none;"><span class="icon">üí∞</span> <span>–ü–æ–ª—É—á–µ–Ω–æ</span></button> <button class="nav-tab" id="nav-journal" onclick="switchTab('journal')"><span class="icon">üìÑ</span> <span>–ñ—É—Ä–Ω–∞–ª</span></button> <button class="nav-tab" id="nav-transfers" onclick="switchTab('transfers')" style="display: none;"><span class="icon">‚û°Ô∏è</span> <span>–í—Ö–æ–¥—è—â–∏–µ</span></button> <button class="nav-tab" id="nav-balances" onclick="switchTab('balances')"><span class="icon">üè¶</span> <span>–ë–∞–ª–∞–Ω—Å—ã</span></button> <button class="nav-tab" id="nav-analytics" onclick="switchTab('analytics')"><span class="icon">üìà</span> <span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span></button> <button class="nav-tab" id="nav-approvals" onclick="switchTab('approvals')"><span class="icon">‚úÖ</span> <span>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</span></button> </div> </div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    <div class="content-wrapper" id="contentWrapper"> <div class="container"> <div id="alertContainer" style="padding: 20px 20px 0;"> <div id="successAlert" class="alert alert-success"></div> <div id="errorAlert" class="alert alert-error"></div> <div id="warningAlert" class="alert alert-warning"></div> <div id="infoAlert" class="alert alert-info"></div> </div> 
        <div id="dashboard" class="content active"> <div class="cards-grid"> <div class="card"> <h3>–ú–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã</h3> <div class="value" id="totalExpenses">0 ‚ÇΩ</div> </div> <div class="card"> <h3>–ú–Ω–µ –≤—ã–¥–∞–Ω–æ</h3> <div class="value" id="totalIssued">0 ‚ÇΩ</div> </div> <div class="card"> <h3>–ú–æ–∏ –∑–∞–ø—Ä–æ—Å—ã</h3> <div class="value" id="pendingRequests">0</div> </div> <div class="card positive"> <h3>–ú–æ–π –±–∞–ª–∞–Ω—Å</h3> <div class="value" id="totalBalance">0 ‚ÇΩ</div> </div> <div class="card info" id="responsibleBalanceCard" style="display: none;"> <h3>–ë–∞–ª–∞–Ω—Å –û—Ç–≤–µ—Ç—Å—Ç–≤.</h3> <div class="value" id="responsibleBalance">0 ‚ÇΩ</div> </div> </div> <div class="action-buttons"> <div class="action-card primary" onclick="openModal('requestFundsModal')"> <div class="action-card-icon">üì•</div> <div class="action-card-title">–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞</div> </div> <div class="action-card success" onclick="openModal('recordExpenseModal')"> <div class="action-card-icon">üí∏</div> <div class="action-card-title">–°–æ–≤–µ—Ä—à–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</div> </div> <div class="action-card warning" onclick="openModal('transferFundsModal')"> <div class="action-card-icon">‚ÜîÔ∏è</div> <div class="action-card-title">–ü–µ—Ä–µ–¥–∞—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞</div> </div> </div> <div class="chart-container"> <h3>üìä –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (30 –¥–Ω–µ–π)</h3> <div class="chart" id="categoryChart"><div class="loading"><div class="spinner"></div></div></div> </div> <div class="chart-container"> <h3>üìà –¢—Ä–µ–Ω–¥ —Ä–∞—Å—Ö–æ–¥–æ–≤ (30 –¥–Ω–µ–π)</h3> <div class="chart" id="trendChart"><div class="loading"><div class="spinner"></div></div></div> </div> </div> 
        <div id="operations" class="content"> <h2 style="margin-bottom: 20px;">üíº –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏</h2> <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;"> <div class="action-card primary" onclick="openModal('requestFundsModal')" style="cursor: pointer;"> <div class="action-card-icon">üì•</div> <div class="action-card-title">–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞</div> <p style="font-size: 12px; margin-top: 10px; opacity: 0.9;">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–µ–Ω–µ–∂–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞</p> </div> <div class="action-card success" onclick="openModal('recordExpenseModal')" style="cursor: pointer;"> <div class="action-card-icon">üí∏</div> <div class="action-card-title">–°–æ–≤–µ—Ä—à–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</div> <p style="font-size: 12px; margin-top: 10px; opacity: 0.9;">–ó–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</p> </div> <div class="action-card warning" onclick="openModal('transferFundsModal')" style="cursor: pointer;"> <div class="action-card-icon">‚ÜîÔ∏è</div> <div class="action-card-title">–ü–µ—Ä–µ–¥–∞—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞</div> <p style="font-size: 12px; margin-top: 10px; opacity: 0.9;">–ü–µ—Ä–µ–¥–∞—Ç—å –¥–µ–Ω–µ–∂–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É</p> </div> </div> </div> 
        <div id="received" class="content"> <h2 style="margin-bottom: 20px;">üí∞ –ü–æ–ª—É—á–µ–Ω–æ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</h2> <div class="loading"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div> </div> 
        <div id="journal" class="content"> <h2 style="margin-bottom: 20px;">üìã –ñ—É—Ä–Ω–∞–ª –æ–ø–µ—Ä–∞—Ü–∏–π</h2> <div class="filters"> <div class="filter-group"> <label>–î–∞—Ç–∞ –æ—Ç</label> <input type="date" id="filterDateFrom" onchange="applyFilters()"> </div> <div class="filter-group"> <label>–î–∞—Ç–∞ –¥–æ</label> <input type="date" id="filterDateTo" onchange="applyFilters()"> </div> <div class="filter-group"> <label>–¢–∏–ø</label> <select id="filterType" onchange="applyFilters()"> <option value="">–í—Å–µ</option> <option value="–ó–∞–ø—Ä–æ—Å">–ó–∞–ø—Ä–æ—Å</option> <option value="–í—ã–¥–∞—á–∞">–í—ã–¥–∞—á–∞</option> <option value="–†–∞—Å—Ö–æ–¥">–†–∞—Å—Ö–æ–¥</option> <option value="–í–æ–∑–≤—Ä–∞—Ç">–í–æ–∑–≤—Ä–∞—Ç</option> <option value="–ü–µ—Ä–µ–¥–∞—á–∞">–ü–µ—Ä–µ–¥–∞—á–∞</option> </select> </div> <div class="filter-group"> <label>–°—Ç–∞—Ç—É—Å</label> <select id="filterStatus" onchange="applyFilters()"> <option value="">–í—Å–µ</option> <option value="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</option> <option value="–û–∂–∏–¥–∞–µ—Ç">–û–∂–∏–¥–∞–µ—Ç</option> <option value="–û—Ç–∫–ª–æ–Ω–µ–Ω–æ">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option> </select> </div> <div class="filter-buttons"> <button class="btn btn-primary" onclick="applyFilters()">üîç</button> <button class="btn btn-secondary" onclick="resetFilters()">‚Ü∫</button> <button class="btn btn-success" onclick="exportToCSV()">üì• CSV</button> </div> </div> <div class="table-container"> <table id="journalTable"> <thead> <tr> <th>–î–∞—Ç–∞</th> <th>ID</th> <th>–¢–∏–ø</th> <th>–°—Ç–∞—Ç—É—Å</th> <th>–°—É–º–º–∞</th> <th>–û—Ç –∫–æ–≥–æ</th> <th>–ö–æ–º—É</th> <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th> <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th> </tr> </thead> <tbody id="journalBody"> <tr><td colspan="9" class="loading"><div class="spinner"></div></td></tr> </tbody> </table> </div> </div> 
        <div id="transfers" class="content"> <h2 style="margin-bottom: 20px;">‚û°Ô∏è –í—Ö–æ–¥—è—â–∏–µ –ø–µ—Ä–µ–≤–æ–¥—ã</h2> <div class="empty-state"> <div class="loading"><div class="spinner"></div></div> </div> </div> 
        <div id="balances" class="content"> <h2 style="margin-bottom: 20px;">üíµ –ë–∞–ª–∞–Ω—Å—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h2> <div class="balance-list" id="balancesList"> <div class="loading"><div class="spinner"></div></div> </div> </div> 
        <div id="analytics" class="content"> <h2 style="margin-bottom: 20px;">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2> <div class="filters"> <div class="filter-group"> <label>–ü–µ—Ä–∏–æ–¥</label> <select id="analyticsPeriod" onchange="loadAnalytics()"> <option value="daily">–ü–æ –¥–Ω—è–º</option> <option value="weekly">–ü–æ –Ω–µ–¥–µ–ª—è–º</option> <option value="monthly" selected>–ü–æ –º–µ—Å—è—Ü–∞–º</option> <option value="yearly">–ü–æ –≥–æ–¥–∞–º</option> </select> </div> <div class="filter-group"> <label>–ú–µ—Å—è—Ü—ã –Ω–∞–∑–∞–¥</label> <select id="analyticsMonths" onchange="loadAnalytics()"> <option value="1">1 –º–µ—Å.</option> <option value="3" selected>3 –º–µ—Å.</option> <option value="6">6 –º–µ—Å.</option> <option value="12">–ì–æ–¥</option> </select> </div> <div class="filter-group"> <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label> <select id="analyticsEmployee" onchange="loadAnalytics()"> <option value="">–í—Å–µ</option> </select> </div> </div> <div class="chart-container"> <h3>üìä –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3> <div class="chart" id="analyticsCategoryChart"><div class="loading"><div class="spinner"></div></div></div> </div> <div class="chart-container"> <h3>üë• –†–∞—Å—Ö–æ–¥—ã –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</h3> <div class="chart" id="analyticsEmployeeChart"><div class="loading"><div class="spinner"></div></div></div> </div> <div class="chart-container"> <h3>üìà –¢—Ä–µ–Ω–¥ —Ä–∞—Å—Ö–æ–¥–æ–≤</h3> <div class="chart" id="analyticsTrendChart"><div class="loading"><div class="spinner"></div></div></div> </div> </div> 
        <div id="approvals" class="content"> <h2 style="margin-bottom: 20px;">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤</h2> <div class="table-container"> <table id="approvalsTable"> <thead> <tr> <th>–î–∞—Ç–∞</th> <th>ID</th> <th>–û—Ç –∫–æ–≥–æ</th> <th>–°—É–º–º–∞</th> <th>–°—Ç–∞—Ç—É—Å</th> <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th> <th>–î–µ–π—Å—Ç–≤–∏–µ</th> </tr> </thead> <tbody id="approvalsBody"> <tr><td colspan="7" class="loading"><div class="spinner"></div></td></tr> </tbody> </table> </div> </div> 
    </div> </div> 
    <div id="requestFundsModal" class="modal"> <div class="modal-content"> <div class="modal-header"> <h2>üì• –ó–∞–ø—Ä–æ—Å–∏—Ç—å</h2> <button class="modal-close" onclick="closeModal('requestFundsModal')">‚úï</button> </div> <form onsubmit="submitRequestFunds(event)"> <div class="form-group"> <label>–°—É–º–º–∞ (‚ÇΩ)</label> <input type="number" id="requestAmount" min="1" step="0.01" required> </div> <div class="form-group"> <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label> <textarea id="requestComment" rows="3"></textarea> </div> <button type="submit" class="btn btn-primary btn-block">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button> </form> </div> </div>
    <div id="recordExpenseModal" class="modal"> <div class="modal-content"> <div class="modal-header"> <h2>üí∏ –†–∞—Å—Ö–æ–¥</h2> <button class="modal-close" onclick="closeModal('recordExpenseModal')">‚úï</button> </div> <form onsubmit="submitRecordExpense(event)"> <div class="form-group"> <label>–°—É–º–º–∞ (‚ÇΩ)</label> <input type="number" id="expenseAmount" min="1" step="0.01" required> </div> <div class="form-group"> <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label> <div style="display: flex; gap: 10px;"> <select id="expenseCategory" required onchange="updateSubcategories()"> <option value="">–í—ã–±—Ä–∞—Ç—å...</option> </select> <button type="button" class="btn btn-secondary btn-small" id="addCategoryBtn" onclick="openModal('addCategoryModal')" style="display: none;">+</button> </div> </div> <div class="form-group"> <label>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</label> <select id="expenseSubcategory" required> <option value="">–í—ã–±—Ä–∞—Ç—å...</option> </select> </div> <div class="form-group"> <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label> <textarea id="expenseComment" rows="3"></textarea> </div> <button type="submit" class="btn btn-primary btn-block">–ó–∞–ø–∏—Å–∞—Ç—å</button> </form> </div> </div>
    <div id="transferFundsModal" class="modal"> <div class="modal-content"> <div class="modal-header"> <h2>‚ÜîÔ∏è –ü–µ—Ä–µ–¥–∞—Ç—å</h2> <button class="modal-close" onclick="closeModal('transferFundsModal')">‚úï</button> </div> <form onsubmit="submitTransferFunds(event)"> <div class="form-group"> <label>–ö–æ–º—É</label> <select id="transferTo" required> <option value="">–í—ã–±—Ä–∞—Ç—å...</option> </select> </div> <div class="form-group"> <label>–°—É–º–º–∞ (‚ÇΩ)</label> <input type="number" id="transferAmount" min="1" step="0.01" required> </div> <div class="form-group"> <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label> <textarea id="transferComment" rows="3"></textarea> </div> <button type="submit" class="btn btn-primary btn-block">–ü–µ—Ä–µ–¥–∞—Ç—å</button> </form> </div> </div>
    <div id="addCategoryModal" class="modal"> <div class="modal-content"> <div class="modal-header"> <h2>üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</h2> <button class="modal-close" onclick="closeModal('addCategoryModal')">‚úï</button> </div> <form onsubmit="submitAddCategory(event)"> <div class="form-group"> <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label> <input type="text" id="newCategory" required> </div> <div class="form-group"> <label>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</label> <input type="text" id="newSubcategory" required> </div> <button type="submit" class="btn btn-primary btn-block">–î–æ–±–∞–≤–∏—Ç—å</button> </form> </div> </div>
    <div class="bottom-nav" id="bottomNav"> <button class="bottom-nav-item" onclick="openModal('requestFundsModal')"> <span class="icon">üì•</span> <span>–ó–∞–ø—Ä–æ—Å–∏—Ç—å</span> </button> <button class="bottom-nav-item" onclick="openModal('recordExpenseModal')"> <span class="icon">üí∏</span> <span>–†–∞—Å—Ö–æ–¥</span> </button> <button class="bottom-nav-item" onclick="openModal('transferFundsModal')"> <span class="icon">‚ÜîÔ∏è</span> <span>–ü–µ—Ä–µ–¥–∞—Ç—å</span> </button> <button class="bottom-nav-item" id="bottomNavBalance" style="display: none;" onclick="switchTab('balances')"> <span class="icon">üè¶</span> <span>–ë–∞–ª–∞–Ω—Å</span> </button> <button class="bottom-nav-item" id="bottomNavMenu" onclick="openSidebar()"> <span class="icon">‚ò∞</span> <span>–ú–µ–Ω—é</span> </button> </div>

    <script>
        // ============================================================================
        // API "–ú–û–°–¢" 
        // ============================================================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbxztQgwaMKfXVSjubNKK90IYKtbye7N3S-WtMAwn_N7E6PONbAOAtwPUlglmMA0YKjLWQ/exec'; 
        async function callApi(action, payload = {}) { console.log(`üöÄ API Call: ${action}`, payload); try { const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action, payload }) }); const responseText = await response.text(); console.log(`üì¨ API Response (${action}): ${response.status} ${response.statusText}`, responseText); if (!response.ok) { throw new Error(`Network error: ${response.status} ${response.statusText}. Response: ${responseText}`); } let result; try { result = JSON.parse(responseText); } catch (jsonError) { console.error('JSON Parse Error:', jsonError); throw new Error(`Failed to parse server response: ${responseText}`); } if (result.success === false && result.error) { throw new Error(result.error); } console.log(`‚úÖ API Success (${action}):`, result); return result; } catch (error) { console.error(`‚ùå API Error (${action}):`, error); showAlert(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ API (${action}): ${error.message}`, 'error'); throw error; } }
        
        // ============================================================================
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        // ============================================================================
        let allData = { log: [], balances: [], admin: [] }; let currentTheme = localStorage.getItem('theme') || 'light'; let currentUserId = null; let currentUserRole = '–ó–∞–≥—Ä—É–∑–∫–∞...'; let categoriesData = {};
        function getTelegramUserId() { try { if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) { const d = window.Telegram.WebApp.initDataUnsafe; if (d.user && d.user.id) { console.log('‚úÖ TG User ID:', d.user.id); return String(d.user.id); } else { console.warn('No user.id in initData:', d); } } else { console.log('TG WebApp not found.'); } } catch (e) { console.error('‚ùå Error getting TG InitData:', e); } const defaultId = '1125736'; console.warn(`‚ö†Ô∏è Using default ID: ${defaultId}`); return defaultId; }
        
        // ============================================================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ============================================================================
        document.addEventListener('DOMContentLoaded', function() { const s=document.createElement('script'); s.src='https://telegram.org/js/telegram-web-app.js'; s.async=true; s.onload=()=>{ console.log('‚úÖ TG script loaded.'); if(window.Telegram && window.Telegram.WebApp){ try{window.Telegram.WebApp.ready(); window.Telegram.WebApp.expand(); console.log('TG ready() & expand()');}catch(e){console.error("TG methods error: ", e);}} initializeWebApp(); }; s.onerror=()=>{console.error('‚ùå TG script failed.'); initializeWebApp();}; document.head.appendChild(s); });
        async function initializeWebApp() { console.log('üöÄ App init...'); currentUserId = getTelegramUserId(); localStorage.setItem('userId', currentUserId); console.log('üë§ User ID:', currentUserId); applyTheme(currentTheme); await loadData(); setInterval(loadData, 30000); console.log('üèÅ Init done.'); }
        
        // ============================================================================
        // SIDEBAR & –ù–ê–í–ò–ì–ê–¶–ò–Ø
        // ============================================================================
        function openSidebar() { document.getElementById('sidebar').classList.add('active'); document.getElementById('sidebarOverlay').classList.add('active'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('active'); document.getElementById('sidebarOverlay').classList.remove('active'); }
        function switchTab(tabName) { document.querySelectorAll('.content').forEach(c => c.classList.remove('active')); document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active')); const c = document.getElementById(tabName), t = document.getElementById('nav-' + tabName); if (c) c.classList.add('active'); if (t) t.classList.add('active'); if (tabName === 'journal') { loadJournal(); } else if (tabName === 'balances') { loadBalances(); } else if (tabName === 'analytics') { loadAnalytics(); } else if (tabName === 'approvals') { loadApprovals(); } else if (tabName === 'received') { loadReceivedMoney(); } else if (tabName === 'transfers') { loadPendingTransfers(); } closeSidebar(); }
        
        // ============================================================================
        // –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
        // ============================================================================
        async function loadData() { console.log('üì® Loading data...'); try { const data = await callApi('getData'); console.log('‚úÖ Data received:', data); allData = { log: Array.isArray(data.log)?data.log:[], balances: Array.isArray(data.balances)?data.balances:[], admin: Array.isArray(data.admin)?data.admin:[] }; console.log('üíæ Data stored:', allData); checkCategoryManagementAccess(); updateDashboard(); populateSelects(); await loadCategories(); const activeTab = document.querySelector('.nav-tab.active'); if (activeTab) { const name = activeTab.id.replace('nav-', ''); if (name !== 'dashboard') { const func = 'load' + name.charAt(0).toUpperCase() + name.slice(1); if (typeof window[func] === 'function') { window[func](); } else if (name === 'received') { loadReceivedMoney(); } else if (name === 'transfers') { loadPendingTransfers(); } } } } catch (e) { console.error('‚ùå Critical load error:', e); showAlert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ' + e.message, 'error'); } }
        
        // ============================================================================
        // DASHBOARD (–í–ö–õ–Æ–ß–ê–Ø –ö–ê–†–¢–û–ß–ö–ò –ò –ì–†–ê–§–ò–ö–ò)
        // ============================================================================
        function updateDashboard() { try { const log = allData.log || [], balances = allData.balances || []; console.log('üìä Updating Dashboard for:', currentUserId, currentUserRole); let exp = 0, iss = 0, req = 0, bal = 0, respBal = 0, respId = null; const balRec = balances.find(b => Array.isArray(b) && String(b[0]).trim() === currentUserId); if (balRec) { bal = parseFloat(balRec[2]) || 0; } if (currentUserRole === '–î–∏—Ä–µ–∫—Ç–æ—Ä') { const respRec = allData.admin.find(a => Array.isArray(a) && a[1] === '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'); if (respRec) { respId = String(respRec[0]).trim(); const rBalRec = balances.find(b => Array.isArray(b) && String(b[0]).trim() === respId); if (rBalRec) { respBal = parseFloat(rBalRec[2]) || 0; } } } const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30); log.forEach(entry => { if (!Array.isArray(entry) || entry.length < 12) return; const type = String(entry[2]||''), status = String(entry[3]||''), amount = parseFloat(entry[4])||0, fromId = String(entry[5]||''), toId = String(entry[6]||''), date = new Date(entry[0]); if ((type === '–†–∞—Å—Ö–æ–¥' || type === '–í–æ–∑–≤—Ä–∞—Ç') && fromId === currentUserId) { exp += Math.abs(amount); } if (currentUserRole === '–î–∏—Ä–µ–∫—Ç–æ—Ä' || currentUserRole === '–ë—É—Ö–≥–∞–ª—Ç–µ—Ä') { if (type === '–í—ã–¥–∞—á–∞' && status === '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ') { iss += amount; } } else { if (((type === '–í—ã–¥–∞—á–∞') || (type === '–ü–µ—Ä–µ–¥–∞—á–∞' && status === '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ')) && toId === currentUserId) { iss += amount; } } if (type === '–ó–∞–ø—Ä–æ—Å' && status === '–û–∂–∏–¥–∞–µ—Ç' && fromId === currentUserId) { req++; } }); document.getElementById('totalExpenses').textContent = formatCurrency(exp); document.getElementById('totalIssued').textContent = formatCurrency(iss); document.getElementById('pendingRequests').textContent = req; document.getElementById('totalBalance').textContent = formatCurrency(bal); const respCard = document.getElementById('responsibleBalanceCard'), respVal = document.getElementById('responsibleBalance'); if (respCard && respVal) { if (currentUserRole === '–î–∏—Ä–µ–∫—Ç–æ—Ä' && respId) { respVal.textContent = formatCurrency(respBal); respCard.style.display = 'block'; } else { respCard.style.display = 'none'; } } displayDashboardCharts(); console.log('‚úÖ Dashboard updated.'); } catch(e) { console.error("‚ùå Error updating Dashboard:", e); showAlert("–û—à–∏–±–∫–∞ –≥–ª–∞–≤–Ω–æ–π: " + e.message, 'error'); } }
        function displayDashboardCharts() { const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30); thirtyDaysAgo.setHours(0,0,0,0); const expensesLast30Days = allData.log.filter(entry => Array.isArray(entry) && entry.length > 8 && entry[2] === '–†–∞—Å—Ö–æ–¥' && new Date(entry[0]) >= thirtyDaysAgo); const categoryData = aggregateDataByCategory(expensesLast30Days); renderBarChart('categoryChart', categoryData); const trendData = aggregateDataByPeriod(expensesLast30Days, 'daily'); renderBarChart('trendChart', trendData); }
        
        // ============================================================================
        // –û–ü–ï–†–ê–¶–ò–ò - –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–•
        // ============================================================================
        async function submitRequestFunds(event) { event.preventDefault(); const a=document.getElementById('requestAmount'), c=document.getElementById('requestComment'), am=parseFloat(a.value), cm=c.value; if(!am||am<=0){showAlert('–°—É–º–º–∞?', 'error'); a.focus(); return;} if(!currentUserId){showAlert('ID?', 'error'); return;} const p={userId:currentUserId, amount:am, comment:cm}, b=event.target.querySelector('button[type="submit"]'); try {b.disabled=true; b.textContent='–û—Ç–ø—Ä–∞–≤–∫–∞...'; const r=await callApi('recordRequestFunds', p); if(r.success){showAlert('‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!','success'); closeModal('requestFundsModal'); a.value=''; c.value=''; await loadData();}else{showAlert('‚ùå –û—à–∏–±–∫–∞: '+(r.error||'?'), 'error');}}catch(e){showAlert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: '+e.message, 'error');}finally{b.disabled=false; b.textContent='–û—Ç–ø—Ä–∞–≤–∏—Ç—å';} }
        async function submitRecordExpense(event) { event.preventDefault(); const a=document.getElementById('expenseAmount'), cat=document.getElementById('expenseCategory'), sub=document.getElementById('expenseSubcategory'), c=document.getElementById('expenseComment'), am=parseFloat(a.value), ct=cat.value, sb=sub.value, cm=c.value; if(!am||am<=0){showAlert('–°—É–º–º–∞?','error'); a.focus(); return;} if(!ct){showAlert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è?','error'); cat.focus(); return;} if(!sb){showAlert('–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è?','error'); sub.focus(); return;} if(!currentUserId){showAlert('ID?','error'); return;} const p={userId:currentUserId, amount:am, category:ct, subcategory:sb, comment:cm}, b=event.target.querySelector('button[type="submit"]'); try {b.disabled=true; b.textContent='–ó–∞–ø–∏—Å—å...'; const r=await callApi('recordExpense',p); if(r.success){showAlert('‚úÖ –†–∞—Å—Ö–æ–¥ –∑–∞–ø–∏—Å–∞–Ω!','success'); closeModal('recordExpenseModal'); a.value=''; cat.value=''; sub.innerHTML='<option value="">–í—ã–±—Ä–∞—Ç—å...</option>'; c.value=''; await loadData();}else{showAlert('‚ùå –û—à–∏–±–∫–∞: '+(r.error||'?'), 'error');}}catch(e){showAlert('‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—Ö–æ–¥–∞: '+e.message, 'error');}finally{b.disabled=false; b.textContent='–ó–∞–ø–∏—Å–∞—Ç—å';} }
        async function submitTransferFunds(event) { event.preventDefault(); const t=document.getElementById('transferTo'), a=document.getElementById('transferAmount'), c=document.getElementById('transferComment'), toId=t.value, am=parseFloat(a.value), cm=c.value; if(!toId){showAlert('–ü–æ–ª—É—á–∞—Ç–µ–ª—å?','error'); t.focus(); return;} if(!am||am<=0){showAlert('–°—É–º–º–∞?','error'); a.focus(); return;} if(!currentUserId){showAlert('ID?','error'); return;} if(toId===currentUserId){showAlert('–°–µ–±–µ –Ω–µ–ª—å–∑—è','warning'); return;} const p={fromId:currentUserId, toId:toId, amount:am, comment:cm}, b=event.target.querySelector('button[type="submit"]'); try {b.disabled=true; b.textContent='–û—Ç–ø—Ä–∞–≤–∫–∞...'; const r=await callApi('recordTransfer',p); if(r.success){showAlert('‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –ñ–¥–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.','info'); closeModal('transferFundsModal'); t.value=''; a.value=''; c.value=''; await loadData();}else{showAlert('‚ùå –û—à–∏–±–∫–∞: '+(r.error||'?'), 'error');}}catch(e){showAlert('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: '+e.message, 'error');}finally{b.disabled=false; b.textContent='–ü–µ—Ä–µ–¥–∞—Ç—å';} }
        
        // ============================================================================
        // –ñ–£–†–ù–ê–õ
        // ============================================================================
        function loadJournal() { try { const l=allData.log||[],t=document.getElementById('journalBody');console.log('üì∞ –ñ—É—Ä–Ω–∞–ª:', l.length); if(l.length===0){t.innerHTML='<tr><td colspan="9" class="empty-state">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';return;} let h=''; for(let i=l.length-1;i>=0;i--){const e=l[i];if(!Array.isArray(e)||e.length<12){console.warn("Skip:",e);continue;} try{const d=e[0]?new Date(e[0]).toLocaleDateString('ru-RU'):'N/A',id=e[1]||'N/A',tp=e[2]||'?',st=e[3]||'?',am=e[4],fr=e[5]||'',to=e[6]||'',cat=e[8]||'',sub=e[9]||'',com=e[11]||'',cl=st==='–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ'?'status-approved':(st==='–û–∂–∏–¥–∞–µ—Ç'?'status-pending':'status-rejected'),fn=getNameById(fr)||fr,tn=getNameById(to)||to; h+=`<tr><td>${d}</td><td><code>${id}</code></td><td>${tp}</td><td><span class="status-badge ${cl}">${st}</span></td><td>${formatCurrency(am)}</td><td>${fn}</td><td>${tn}</td><td>${cat}${sub?' / '+sub:''}</td><td>${com}</td></tr>`;}catch(er){console.error("Row err:",er,e);}} t.innerHTML=h; console.log('‚úÖ –ñ—É—Ä–Ω–∞–ª OK.');}catch(e){console.error("‚ùå –ñ—É—Ä–Ω–∞–ª err:",e);showAlert("–û—à–∏–±–∫–∞ –∂—É—Ä–Ω–∞–ª–∞: "+e.message,'error');}}
        function applyFilters() { try { const l=allData.log||[],dF=document.getElementById('filterDateFrom').value,dT=document.getElementById('filterDateTo').value,tp=document.getElementById('filterType').value,st=document.getElementById('filterStatus').value,df=dF?new Date(dF+'T00:00:00'):null,dt=dT?new Date(dT+'T23:59:59'):null; console.log('üîç –§–∏–ª—å—Ç—Ä—ã:',{df,dt,tp,st}); const t=document.getElementById('journalBody'); let h='',c=0; for(let i=l.length-1;i>=0;i--){const e=l[i];if(!Array.isArray(e)||e.length<12)continue; try{const ed=e[0]?new Date(e[0]):null;if(!ed)continue; const et=String(e[2]||''),es=String(e[3]||''); let m=true; if(df&&ed<df)m=false; if(dt&&ed>dt)m=false; if(tp&&et!==tp)m=false; if(st&&es!==st)m=false; if(m){c++; const ds=ed.toLocaleDateString('ru-RU'),id=e[1]||'N/A',am=e[4],fr=e[5]||'',to=e[6]||'',cat=e[8]||'',sub=e[9]||'',com=e[11]||'',cl=es==='–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ'?'status-approved':(es==='–û–∂–∏–¥–∞–µ—Ç'?'status-pending':'status-rejected'),fn=getNameById(fr)||fr,tn=getNameById(to)||to; h+=`<tr><td>${ds}</td><td><code>${id}</code></td><td>${et}</td><td><span class="status-badge ${cl}">${es}</span></td><td>${formatCurrency(am)}</td><td>${fn}</td><td>${tn}</td><td>${cat}${sub?' / '+sub:''}</td><td>${com}</td></tr>`;}}catch(er){console.error("Filter row err:",er,e);}} t.innerHTML=h||`<tr><td colspan="9" class="empty-state">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö (${c})</td></tr>`; console.log(`‚úÖ –§–∏–ª—å—Ç—Ä—ã: ${c}.`);}catch(e){console.error("‚ùå –§–∏–ª—å—Ç—Ä—ã err:",e);showAlert("–û—à–∏–±–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤: "+e.message,'error');}}
        function resetFilters() { document.getElementById('filterDateFrom').value=''; document.getElementById('filterDateTo').value=''; document.getElementById('filterType').value=''; document.getElementById('filterStatus').value=''; loadJournal(); console.log('–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã.'); }
        function exportToCSV() { /* ... –ö–æ–¥ —ç–∫—Å–ø–æ—Ä—Ç–∞ ... */ }
        
        // ============================================================================
        // –ë–ê–õ–ê–ù–°–´
        // ============================================================================
        function loadBalances() { try { const b=allData.balances||[],c=document.getElementById('balancesList');console.log('üíµ –ë–∞–ª–∞–Ω—Å—ã:', b.length); if(b.length===0){c.innerHTML='<div class="empty-state">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';return;} let h=''; b.forEach(i=>{if(!Array.isArray(i)||i.length<3){console.warn("Skip balance:",i);return;} const id=i[0],n=i[1]||'?',v=parseFloat(i[2])||0,cl=v>=0?'positive':'negative'; h+=`<div class="balance-item"><div class="balance-item-info"><h4>${n}</h4><p>ID: ${id}</p></div><div class="balance-item-value ${cl}">${formatCurrency(v)}</div></div>`;}); c.innerHTML=h; console.log('‚úÖ –ë–∞–ª–∞–Ω—Å—ã OK.');}catch(e){console.error("‚ùå –ë–∞–ª–∞–Ω—Å—ã err:",e);showAlert("–û—à–∏–±–∫–∞ –±–∞–ª–∞–Ω—Å–æ–≤: "+e.message,'error');}}
        
        // ============================================================================
        // "–ü–û–õ–£–ß–ï–ù–û"
        // ============================================================================
        function loadReceivedMoney() { const c=document.getElementById('received');if(!c)return; console.log('üí∞ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—É—á–µ–Ω–æ...'); try { const l=allData.log||[],n=new Date(),f=new Date(n.getFullYear(),n.getMonth(),1); let t=0; l.forEach(e=>{if(!Array.isArray(e)||e.length<7)return; const d=new Date(e[0]),tp=String(e[2]||''),st=String(e[3]||''),to=String(e[6]||''),am=parseFloat(e[4])||0; if(st==='–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ'&&to===currentUserId&&(tp==='–í—ã–¥–∞—á–∞'||tp==='–ü–µ—Ä–µ–¥–∞—á–∞')&&d>=f){t+=am;}}); console.log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ: ${t}`); c.innerHTML=`<h2 style="margin-bottom: 20px;">üí∞ –ü–æ–ª—É—á–µ–Ω–æ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</h2><div class="cards-grid"><div class="card positive" style="grid-column: 1 / -1;"><h3>–í—Å–µ–≥–æ –ø–æ–ª—É—á–µ–Ω–æ</h3><div class="value">${formatCurrency(t)}</div></div></div><div class="chart-container"><h3>–ì—Ä–∞—Ñ–∏–∫</h3><div class="chart">–ì—Ä–∞—Ñ–∏–∫ –∑–¥–µ—Å—å...</div></div>`;}catch(e){console.error("‚ùå '–ü–æ–ª—É—á–µ–Ω–æ' err:",e);c.innerHTML='<div class="empty-state">–û—à–∏–±–∫–∞.</div>';}}
        
        // ============================================================================
        // "–í–•–û–î–Ø–©–ò–ï"
        // ============================================================================
        function loadPendingTransfers() { const c=document.getElementById('transfers');if(!c)return; console.log('‚û°Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö...'); try { const l=allData.log||[],p=l.filter(e=>Array.isArray(e)&&e.length>12&&e[2]==='–ü–µ—Ä–µ–¥–∞—á–∞'&&e[3]==='–û–∂–∏–¥–∞–µ—Ç'&&String(e[6]||'')===currentUserId); if(p.length===0){c.innerHTML=`<h2 style="margin-bottom: 20px;">‚û°Ô∏è –í—Ö–æ–¥—è—â–∏–µ</h2><div class="empty-state">–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö</div>`;return;} let h=`<h2 style="margin-bottom: 20px;">‚û°Ô∏è –í—Ö–æ–¥—è—â–∏–µ</h2><div class="table-container"><table id="pendingTransfersTable"><thead><tr><th>–î–∞—Ç–∞</th><th>ID</th><th>–û—Ç –∫–æ–≥–æ</th><th>–°—É–º–º–∞</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead><tbody>`; p.sort((a,b)=>new Date(b[0])-new Date(a[0])); p.forEach(e=>{const id=e[1]||'N/A',fr=String(e[5]||''),fn=getNameById(fr),am=e[4],d=e[0]?new Date(e[0]).toLocaleDateString('ru-RU'):'N/A',com=e[11]||''; h+=`<tr><td>${d}</td><td><code>${id}</code></td><td>${fn}</td><td>${formatCurrency(am)}</td><td>${com}</td><td><button class="btn btn-success btn-small" onclick="approveTransfer('${id}')">ü§ù</button> <button class="btn btn-danger btn-small" onclick="rejectTransfer('${id}')">‚õî</button></td></tr>`;}); h+=`</tbody></table></div>`; c.innerHTML=h;}catch(e){console.error("‚ùå '–í—Ö–æ–¥—è—â–∏–µ' err:",e);c.innerHTML='<div class="empty-state">–û—à–∏–±–∫–∞.</div>';}}
        async function approveTransfer(id) { console.log(`ü§ù –ü—Ä–∏–Ω—è—Ç—å: ${id}`); const p={transferId:id, userId:currentUserId},ab=document.querySelector(`button[onclick="approveTransfer('${id}')"]`),rb=document.querySelector(`button[onclick="rejectTransfer('${id}')"]`); try { if(ab)ab.disabled=true; if(rb)rb.disabled=true; const r=await callApi('approveTransfer',p); if(r.success){showAlert('‚úÖ –ü—Ä–∏–Ω—è—Ç–æ!','success'); await loadData(); loadPendingTransfers();}else{showAlert('‚ùå –û—à–∏–±–∫–∞: '+(r.error||'?'),'error'); if(ab)ab.disabled=false; if(rb)rb.disabled=false;}}catch(e){showAlert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: '+e.message,'error'); if(ab)ab.disabled=false; if(rb)rb.disabled=false;}}
        async function rejectTransfer(id) { console.log(`‚õî –û—Ç–∫–ª–æ–Ω–∏—Ç—å: ${id}`); const p={transferId:id, userId:currentUserId},ab=document.querySelector(`button[onclick="approveTransfer('${id}')"]`),rb=document.querySelector(`button[onclick="rejectTransfer('${id}')"]`); try { if(ab)ab.disabled=true; if(rb)rb.disabled=true; const r=await callApi('rejectTransfer',p); if(r.success){showAlert('‚úÖ –û—Ç–∫–ª–æ–Ω–µ–Ω–æ!','success'); await loadData(); loadPendingTransfers();}else{showAlert('‚ùå –û—à–∏–±–∫–∞: '+(r.error||'?'),'error'); if(ab)ab.disabled=false; if(rb)rb.disabled=false;}}catch(e){showAlert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: '+e.message,'error'); if(ab)ab.disabled=false; if(rb)rb.disabled=false;}}
        
        // ============================================================================
        // –ê–ù–ê–õ–ò–¢–ò–ö–ê (–í–ö–õ–Æ–ß–ê–Ø –ì–†–ê–§–ò–ö–ò)
        // ============================================================================
        function loadAnalytics() { const period=document.getElementById('analyticsPeriod').value, monthsBack=parseInt(document.getElementById('analyticsMonths').value), employeeIdFromFilter=document.getElementById('analyticsEmployee').value, analyticsEmployeeSelect=document.getElementById('analyticsEmployee'); let finalEmployeeId=employeeIdFromFilter; if(currentUserRole==='–°–æ—Ç—Ä—É–¥–Ω–∏–∫'){finalEmployeeId=currentUserId; if(analyticsEmployeeSelect){analyticsEmployeeSelect.value=currentUserId; analyticsEmployeeSelect.disabled=true;}}else{if(analyticsEmployeeSelect){analyticsEmployeeSelect.disabled=false;}} console.log('üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞:', {period, monthsBack, employeeId:finalEmployeeId}); const endDate=new Date(), startDate=new Date(); startDate.setMonth(startDate.getMonth()-monthsBack); startDate.setDate(1); startDate.setHours(0,0,0,0); const filteredLogs=allData.log.filter(e=>{if(!Array.isArray(e)||e.length<12)return false; const d=new Date(e[0]), t=String(e[2]||''), f=String(e[5]||''); if(!(d>=startDate&&d<=endDate))return false; if(t!=='–†–∞—Å—Ö–æ–¥')return false; if(finalEmployeeId&&f!==finalEmployeeId)return false; return true;}); console.log(`üìä –ó–∞–ø–∏—Å–µ–π: ${filteredLogs.length}`); const categoryData=aggregateDataByCategory(filteredLogs); renderBarChart('analyticsCategoryChart', categoryData); const employeeData=aggregateDataByEmployee(filteredLogs); renderBarChart('analyticsEmployeeChart', employeeData); const trendData=aggregateDataByPeriod(filteredLogs, period); renderBarChart('analyticsTrendChart', trendData); }
        function aggregateDataByCategory(logs) { const agg={}; logs.forEach(e=>{const c=String(e[8]||'–ë–µ–∑ –∫–∞—Ç.').trim(), a=parseFloat(e[4])||0; if(a>0){agg[c]=(agg[c]||0)+a;}}); return Object.entries(agg).map(([label, value])=>({label, value})).sort((a,b)=>b.value-a.value); }
        function aggregateDataByEmployee(logs) { const agg={}; logs.forEach(e=>{const id=String(e[5]||'?').trim(), a=parseFloat(e[4])||0; if(a>0){const n=getNameById(id); agg[n]=(agg[n]||0)+a;}}); return Object.entries(agg).map(([label, value])=>({label, value})).sort((a,b)=>b.value-a.value); }
        function aggregateDataByPeriod(logs, periodType) { const agg={}; logs.forEach(e=>{const d=new Date(e[0]), a=parseFloat(e[4])||0; if(a<=0)return; let k=''; if(periodType==='daily'){k=d.toLocaleDateString('ru-RU');}else if(periodType==='weekly'){const s=new Date(d), day=s.getDay(), diff=s.getDate()-day+(day===0?-6:1); s.setDate(diff); k=s.toLocaleDateString('ru-RU');}else if(periodType==='monthly'){k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;}else{k=String(d.getFullYear());} agg[k]=(agg[k]||0)+a;}); const keys=Object.keys(agg).sort((a,b)=>{if(periodType==='daily'||periodType==='weekly'){const dA=a.split('.').reverse().join(''), dB=b.split('.').reverse().join(''); return dA.localeCompare(dB);} return a.localeCompare(b);}); return keys.map(key=>({label:key, value:agg[key]})); }
        function renderBarChart(containerId, data) { const c=document.getElementById(containerId); if(!c)return; if(!data||data.length===0){c.innerHTML='<div class="empty-state-text" style="padding:20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';return;} const maxV=Math.max(...data.map(i=>i.value)); if(maxV<=0){c.innerHTML='<div class="empty-state-text" style="padding:20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';return;} let h='<div class="chart-bars">'; data.forEach(i=>{const hp=(i.value/maxV)*100, dl=i.label.length>10?i.label.substring(0,7)+'...':i.label; h+=`<div class="chart-bar-item" title="${i.label}: ${formatCurrency(i.value)}"><div class="value">${formatCurrency(i.value)}</div><div class="bar" style="height:${hp}%;"></div><div class="label">${dl}</div></div>`;}); h+='</div>'; c.innerHTML=h; }
        
        // ============================================================================
        // –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø
        // ============================================================================
        function getRoleById(id) { const a=allData.admin||[]; for(let i=0;i<a.length;i++){if(Array.isArray(a[i])&&String(a[i][0]).trim()===String(id).trim()){return a[i][1]||'?';}} return '?'; }
        function loadApprovals() { try { const l=allData.log||[],t=document.getElementById('approvalsBody'); const p=l.filter(e=>Array.isArray(e)&&e.length>12&&e[2]==='–ó–∞–ø—Ä–æ—Å'&&e[3]==='–û–∂–∏–¥–∞–µ—Ç'); let h='',c=0; p.forEach(e=>{const id=e[1]||'N/A',reqId=String(e[5]||''),reqRole=getRoleById(reqId),reqName=getNameById(reqId),am=e[4],d=e[0]?new Date(e[0]).toLocaleDateString('ru-RU'):'N/A',com=e[11]||''; let show=false; if(currentUserRole==='–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'&&reqRole==='–°–æ—Ç—Ä—É–¥–Ω–∏–∫'){show=true;}else if((currentUserRole==='–î–∏—Ä–µ–∫—Ç–æ—Ä'||currentUserRole==='–ë—É—Ö–≥–∞–ª—Ç–µ—Ä')&&reqRole==='–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'){show=true;} if(show){c++; let btns=''; if(reqId===currentUserId){btns='<i>(–í–∞—à)</i>';}else{btns=`<button class="btn btn-success btn-small" onclick="approveRequest('${id}')">‚úÖ</button> <button class="btn btn-danger btn-small" onclick="rejectRequest('${id}')">‚ùå</button>`;} h+=`<tr><td>${d}</td><td><code>${id}</code></td><td>${reqName}(${reqRole})</td><td>${formatCurrency(am)}</td><td><span class="status-badge status-pending">–û–∂–∏–¥–∞–µ—Ç</span></td><td>${com}</td><td>${btns}</td></tr>`;}}); if(c===0){t.innerHTML='<tr><td colspan="7" class="empty-state">–ù–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤</td></tr>';}else{t.innerHTML=h;} console.log(`‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: ${c}.`);}catch(e){console.error("‚ùå –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è err:",e);showAlert("–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π: "+e.message,'error');}}
        async function approveRequest(id) { console.log(`üëç –ó–∞–ø—Ä–æ—Å: ${id}`); const p={requestId:id},ab=document.querySelector(`button[onclick="approveRequest('${id}')"]`),rb=document.querySelector(`button[onclick="rejectRequest('${id}')"]`); try { if(ab)ab.disabled=true; if(rb)rb.disabled=true; const r=await callApi('approveRequestWeb',p); if(r.success){showAlert('‚úÖ OK!','success'); await loadData(); if(document.getElementById('approvals').classList.contains('active')){loadApprovals();}}else{showAlert('‚ùå –û—à–∏–±–∫–∞: '+(r.error||'?'),'error'); if(ab)ab.disabled=false; if(rb)rb.disabled=false;}}catch(e){showAlert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: '+e.message,'error'); if(ab)ab.disabled=false; if(rb)rb.disabled=false;}}
        async function rejectRequest(id) { console.log(`üëé –ó–∞–ø—Ä–æ—Å: ${id}`); const p={requestId:id},ab=document.querySelector(`button[onclick="approveRequest('${id}')"]`),rb=document.querySelector(`button[onclick="rejectRequest('${id}')"]`); try { if(ab)ab.disabled=true; if(rb)rb.disabled=true; const r=await callApi('rejectRequestWeb',p); if(r.success){showAlert('‚úÖ –û—Ç–∫–ª–æ–Ω–µ–Ω!','success'); await loadData(); if(document.getElementById('approvals').classList.contains('active')){loadApprovals();}}else{showAlert('‚ùå –û—à–∏–±–∫–∞: '+(r.error||'?'),'error'); if(ab)ab.disabled=false; if(rb)rb.disabled=false;}}catch(e){showAlert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: '+e.message,'error'); if(ab)ab.disabled=false; if(rb)rb.disabled=false;}}
        
        // ============================================================================
        // –ú–û–î–ê–õ–ò
        // ============================================================================
        function openModal(id) { const m=document.getElementById(id); if(m) m.classList.add('active'); }
        function closeModal(id) { const m=document.getElementById(id); if(m) m.classList.remove('active'); }
        
        // ============================================================================
        // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï
        // ============================================================================
        function getNameById(id) { if (!id) return ''; const a=allData.admin||[]; for(let i=0;i<a.length;i++){if(Array.isArray(a[i])&&String(a[i][0]).trim()===String(id).trim()){return a[i][2]||`ID:${id}`;}} return `ID:${id}`; }
        function formatCurrency(v) { const n=parseFloat(v); if(isNaN(n)){return 'N/A ‚ÇΩ';} return new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB',minimumFractionDigits:0,maximumFractionDigits:2}).format(n); }
        function populateSelects() { try { const a=allData.admin||[]; console.log('üë• Select:', a.length); let o='<option value="">–í—ã–±—Ä–∞—Ç—å...</option>', ao='<option value="">–í—Å–µ</option>', c=0; a.forEach(p=>{if(!Array.isArray(p)||p.length<4){console.warn("Skip admin:",p);return;} const id=String(p[0]).trim(), n=p[2]||`ID:${id}`, s=String(p[3]||'').trim().toLowerCase(); if(s==='active'){o+=`<option value="${id}">${n}</option>`; ao+=`<option value="${id}">${n}</option>`; c++;}}); const ts=document.getElementById('transferTo'), as=document.getElementById('analyticsEmployee'); if(ts)ts.innerHTML=o; if(as)as.innerHTML=ao; console.log(`‚úÖ Select: ${c}.`);}catch(e){console.error("‚ùå Select err:",e);showAlert("–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∫–∞: "+e.message,'error');}}
        async function loadCategories() { console.log('üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏...'); try { const c=await callApi('getAllCategories'); console.log('‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏:', c); if(typeof c==='object'&&c!==null){categoriesData=c; updateCategorySelect();}else{console.error('‚ùå –§–æ—Ä–º–∞—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π:',c); categoriesData={}; updateCategorySelect(); showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π.','error');}}catch(e){console.error('‚ùå –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ err:',e); showAlert('‚ùå –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: '+e.message,'error'); categoriesData={}; updateCategorySelect();}}
        function updateCategorySelect() { try { const s=document.getElementById('expenseCategory'); if(!s)return; let o='<option value="">–í—ã–±—Ä–∞—Ç—å...</option>'; const k=Object.keys(categoriesData||{}); console.log('üîÑ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏:', k); k.sort().forEach(c=>{o+=`<option value="${c}">${c}</option>`;}); s.innerHTML=o; updateSubcategories(); console.log('‚úÖ Select –∫–∞—Ç. OK.');}catch(e){console.error("‚ùå Select –∫–∞—Ç. err:",e);showAlert("–û—à–∏–±–∫–∞ –∫–∞—Ç.: "+e.message,'error');}}
        function updateSubcategories() { try { const cs=document.getElementById('expenseCategory'), ss=document.getElementById('expenseSubcategory'); if(!cs||!ss)return; const sc=cs.value; let o='<option value="">–í—ã–±—Ä–∞—Ç—å...</option>'; console.log(`üîÑ –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è "${sc}"`); if(sc&&categoriesData&&Array.isArray(categoriesData[sc])){categoriesData[sc].sort().forEach(s=>{o+=`<option value="${s}">${s}</option>`;});} ss.innerHTML=o; console.log('‚úÖ Select –ø–æ–¥–∫–∞—Ç. OK.');}catch(e){console.error("‚ùå Select –ø–æ–¥–∫–∞—Ç. err:",e);showAlert("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–∞—Ç.: "+e.message,'error');}}
        
        // –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø UI (–° –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ú –û–¢–°–¢–£–ü–û–ú)
        function checkCategoryManagementAccess() {
            const admin = allData.admin || []; let roleFound = false; currentUserRole = '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'; console.log(`üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–ª—è ID: ${currentUserId}`);
            for (let i=0; i<admin.length; i++) { if (Array.isArray(admin[i]) && String(admin[i][0]).trim() === String(currentUserId).trim()) { currentUserRole = admin[i][1] || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'; roleFound = true; console.log(`üë§ –†–æ–ª—å: ${currentUserRole}`); break; } } if (!roleFound) { console.warn(`üë§ –†–æ–ª—å –¥–ª—è ID ${currentUserId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`); }
            const ht=document.getElementById('headerTitle'), urs=document.getElementById('userRole'), addBtn=document.getElementById('addCategoryBtn'), bn=document.getElementById('bottomNav'), cw=document.getElementById('contentWrapper'), body=document.body, bnm=document.getElementById('bottomNavMenu'), bnb=document.getElementById('bottomNavBalance'), nj=document.getElementById('nav-journal'), nt=document.getElementById('nav-transfers'), nbl=document.getElementById('nav-balances'), na=document.getElementById('nav-approvals'), nr=document.getElementById('nav-received'), rc=document.getElementById('responsibleBalanceCard');
            if(ht) ht.textContent=currentUserRole; if(urs) urs.textContent='–†–æ–ª—å: '+currentUserRole; body.classList.remove('director-desktop'); 
            
            // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é Bottom Nav –∏ –æ—Ç—Å—Ç—É–ø–æ–º –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ---
            let isBnVisible = false; 
            const allowedRolesBottomNav = ['–°–æ—Ç—Ä—É–¥–Ω–∏–∫', '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', '–î–∏—Ä–µ–∫—Ç–æ—Ä']; 

            if(bn && cw) { 
                if (roleFound && allowedRolesBottomNav.includes(currentUserRole)) { 
                    bn.style.display = 'flex'; 
                    isBnVisible = true;
                } else { 
                    bn.style.display = 'none'; 
                } 
                // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º margin-bottom = –≤—ã—Å–æ—Ç–µ –ø–∞–Ω–µ–ª–∏ (–±–µ–∑ safe-area, —Ç.–∫. –ø–∞–Ω–µ–ª—å —É–∂–µ –ø–æ–¥–Ω—è—Ç–∞)
                cw.style.marginBottom = isBnVisible ? 'var(--bottom-nav-height)' : '0'; 
                console.log(`üì± –û—Ç—Å—Ç—É–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞: ${cw.style.marginBottom}`); 
            } else { console.error("–ù–µ –Ω–∞–π–¥–µ–Ω #bottomNav –∏–ª–∏ #contentWrapper!"); if(cw) cw.style.marginBottom = '0'; }
            
            // --- –°–±—Ä–æ—Å –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–æ–∫/–≤–∫–ª–∞–¥–æ–∫ ---
            if(bnm)bnm.style.display='flex'; if(nj)nj.style.display='flex'; if(nt)nt.style.display='flex'; if(nbl)nbl.style.display='flex'; if(na)na.style.display='flex'; if(nr)nr.style.display='none'; if(bnb)bnb.style.display='none'; if(rc)rc.style.display='none'; 
            // --- –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è "–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞" ---
            if (currentUserRole === '–°–æ—Ç—Ä—É–¥–Ω–∏–∫') { console.log('üë§ UI –°–æ—Ç—Ä—É–¥–Ω–∏–∫'); if(nj)nj.style.display='none'; if(na)na.style.display='none'; if(nr)nr.style.display='flex'; if(nbl)nbl.style.display='none'; if(bnb)bnb.style.display='flex'; if(bnm)bnm.style.display='none'; } 
            // --- –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è "–î–∏—Ä–µ–∫—Ç–æ—Ä–∞" ---
            else if (currentUserRole === '–î–∏—Ä–µ–∫—Ç–æ—Ä') { console.log('üë§ UI –î–∏—Ä–µ–∫—Ç–æ—Ä'); if(rc)rc.style.display='block'; }
            // --- –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é" ---
            const allowedAdd = ['–î–∏—Ä–µ–∫—Ç–æ—Ä','–ë—É—Ö–≥–∞–ª—Ç–µ—Ä','–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']; if (addBtn) { const canAdd = allowedAdd.includes(currentUserRole); addBtn.style.display=canAdd?'inline-block':'none'; console.log(`üîß –ö–Ω–æ–ø–∫–∞ '+': ${canAdd?'OK':'X'}.`); }
        }

        async function submitAddCategory(event) { event.preventDefault(); const ci=document.getElementById('newCategory'), si=document.getElementById('newSubcategory'), c=ci.value.trim(), s=si.value.trim(); if(!c||!s){showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è','error'); if(!c)ci.focus(); else si.focus(); return;} const p={category:c, subcategory:s}, b=event.target.querySelector('button[type="submit"]'); try {b.disabled=true; b.textContent='–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...'; const r=await callApi('addCategoryToSheet',p); if(r.success){showAlert('‚úÖ OK!','success'); closeModal('addCategoryModal'); ci.value=''; si.value=''; await loadCategories();}else{showAlert(`‚ùå –û—à–∏–±–∫–∞: ${r.error||'?'}`, 'error');}}catch(e){showAlert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: '+e.message,'error');}finally{b.disabled=false; b.textContent='–î–æ–±–∞–≤–∏—Ç—å';}}
        function showAlert(msg, type='info') { const id=type+'Alert', el=document.getElementById(id); if(!el)return; if(el.timerId){clearTimeout(el.timerId);} el.textContent=msg; el.classList.add('active'); el.timerId=setTimeout(()=>{el.classList.remove('active'); el.timerId=null;}, 5000); }
        
        // ============================================================================
        // –¢–ï–ú–ê –ò –ó–ê–ö–†–´–¢–ò–ï –ú–û–î–ê–õ–ï–ô
        // ============================================================================
        function toggleTheme() { currentTheme=currentTheme==='light'?'dark':'light'; localStorage.setItem('theme', currentTheme); applyTheme(currentTheme); const b=document.querySelector('.theme-toggle'); if(b){b.textContent=currentTheme==='light'?'üåô –¢–µ–º–Ω–∞—è':'‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è';}}
        function applyTheme(theme) { if(theme==='dark'){document.body.classList.add('dark-theme');}else{document.body.classList.remove('dark-theme');} console.log(`üé® –¢–µ–º–∞: ${theme}`); const b=document.querySelector('.theme-toggle'); if(b){b.textContent=theme==='light'?'üåô –¢–µ–º–Ω–∞—è':'‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è';}}
        window.onclick = function(event) { if(event.target.classList.contains('modal')){document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));}}
    </script>
</body>
</html>